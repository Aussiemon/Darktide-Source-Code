-- Decompilation Error: _glue_flows(node)

-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
local BackendError = require("scripts/foundation/managers/backend/backend_error")
local BackendInterface = require("scripts/backend/backend_interface")
local BackendUtilities = require("scripts/foundation/managers/backend/utilities/backend_utilities")
local Promise = require("scripts/foundation/utilities/promise")
local BackendManagerTestify = GameParameters.testify and require("scripts/foundation/managers/backend/backend_manager_testify")
local Interface = {
	"authenticated",
	"authentication_failed",
	"authenticate",
	"get_auth_method",
	"account_id",
	"title_request",
	"send_telemetry_events",
	"url_request",
	"get_server_time"
}
local LIMIT_RESPONSE_TIME_WARNING_MS = 2000
local TITLE_REQUEST_RETRY_COUNT = 5
local TIME_SYNC_STATES = table.enum("not_started", "running", "failed", "synced")
local TIME_SYNC_PAUSE_BETWEEN_RETRY_SECONDS = 10
local TIME_SYNC_ACCEPTABLE_LATENCY_SECONDS = 5

local function retry_delay(attempt)
	local temp = math.min(10000, 500 * math.pow(2, attempt))
	local sleep = temp / 2 + math.random(0, temp / 2)

	return sleep / 1000
end

local function is_retryable_error_code(code)
	if code and (code == 429 or code == 1000 or math.floor(code / 100) == 5) then
		return true
	end

	return false
end

local BackendManager = class("BackendManager")

BackendManager.init = function (self, default_headers_ctr)
	self._default_headers_ctr = default_headers_ctr or function ()
		return {}
	end
	self._promises = {}
	self._initialized = false
	self.interfaces = BackendInterface.new()
	self._inflight_title_requests = {}
	self._title_request_retry_queue = {}

	if rawget(_G, "Backend") ~= nil and Backend.initialize ~= nil then
		local auth_url, title_url = nil
		local telemetry_url = DevParameters.backend_telemetry_service_url
		local debug_log = DevParameters.backend_debug_log
		local ok = Backend.initialize(auth_url, title_url, telemetry_url, debug_log)

		if ok then
			self._initialized = true
		end
	end

	self.time_sync_state = TIME_SYNC_STATES.not_started
end

BackendManager.authenticated = function (self)
	return self._auth_cache and self._auth_cache.state == "fulfilled"
end

BackendManager.authentication_failed = function (self)
	return self._auth_cache and self._auth_cache.state == "rejected"
end

local function _check_response_time(path, value)
	local response_time = (value.response_time or 0) * 1000

	if LIMIT_RESPONSE_TIME_WARNING_MS < response_time then
		Managers.telemetry_events:record_slow_response_time(path, math.floor(response_time))
	end
end

BackendManager.update = function (self, dt, t)
	Profiler.start("BackendManager:update()")

	if self._initialized then
		if Backend.did_update_auth_config() then
			self._auth_cache = nil
		end

		self:sync_time(t)

		local results = Backend.update(dt, t)

		if type(results) == "table" then
			for i = 1, #results, 1 do
				local result_mapping = results[i]
				local id = result_mapping.id
				local promise = self._promises[id]

				if promise then
					if result_mapping.error then
						local inflight_request = self._inflight_title_requests[id]

						if result_mapping.error.code and is_retryable_error_code(result_mapping.error.code) and inflight_request and inflight_request.retry_count < TITLE_REQUEST_RETRY_COUNT then
							Log.warning("BackendManager", "Title request failed - will retry after pause:\n%s", BackendUtilities.ERROR_METATABLE.__tostring(result_mapping.error))

							local delay = retry_delay(inflight_request.retry_count)
							inflight_request.request_time = t + delay

							table.insert(self._title_request_retry_queue, inflight_request)

							self._inflight_title_requests[id] = nil
						else
							local error_table = result_mapping.error

							setmetatable(error_table, BackendUtilities.ERROR_METATABLE)
							promise:reject(error_table)

							self._promises[id] = nil
						end
					elseif result_mapping.value then
						promise:resolve(result_mapping.value)

						self._promises[id] = nil
					else
						promise:resolve(nil)

						self._promises[id] = nil
					end
				else
					self:sync_time_result(t, id, result_mapping)
				end
			end
		end

		local remove_indices = {}
		local title_request_retry_queue = self._title_request_retry_queue

		for i = 1, #title_request_retry_queue, 1 do
			local request = title_request_retry_queue[i]

			if request.request_time <= t then
				local previous_operation_identifier = request.operation_identifier
				local promise = self._promises[previous_operation_identifier]

				if promise then
					Log.info("BackendManager", "Retrying request title_request: %s %s", (request.options and request.options.method) or "GET", request.path)

					local operation_identifier, error = Backend.title_request(request.path, request.options)

					if operation_identifier then
						self._promises[previous_operation_identifier] = nil
						self._promises[operation_identifier] = promise
						request.operation_identifier = operation_identifier
						request.retry_count = request.retry_count + 1
						self._inflight_title_requests[operation_identifier] = request

						promise:next(function (_)
							self._inflight_title_requests[operation_identifier] = nil
						end):catch(function (_)
							self._inflight_title_requests[operation_identifier] = nil
						end)
					else

						-- Decompilation error in this vicinity:
						--- BLOCK #0 180-181, warpins: 1 ---
						error = error or "Missing backend operation identifier"

						--- END OF BLOCK #0 ---

						FLOW; TARGET BLOCK #1



						-- Decompilation error in this vicinity:
						--- BLOCK #1 183-194, warpins: 2 ---
						promise:reject(BackendUtilities.create_error(BackendError.NoIdentifier, error))

						self._promises[previous_operation_identifier] = nil
						--- END OF BLOCK #1 ---



					end
				end

				table.insert(remove_indices, i)
			end
		end

		for i = #remove_indices, 1, -1 do

			-- Decompilation error in this vicinity:
			--- BLOCK #0 206-211, warpins: 2 ---
			table.remove(title_request_retry_queue, remove_indices[i])
			--- END OF BLOCK #0 ---



		end
	end

	if GameParameters.testify then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 216-221, warpins: 1 ---
		Testify:poll_requests_through_handler(BackendManagerTestify, self)
		--- END OF BLOCK #0 ---



	end

	Profiler.stop("BackendManager:update()")
end

BackendManager.on_reload = function (self, refreshed_resources)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-7, warpins: 1 ---
	self.interfaces.master_data:on_reload(refreshed_resources)

	return
	--- END OF BLOCK #0 ---



end

BackendManager.logout = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	if self._initialized then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 4-8, warpins: 1 ---
		self._auth_cache = nil

		Backend.logout()
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 9-9, warpins: 2 ---
	return
	--- END OF BLOCK #1 ---



end

BackendManager.authenticate = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	if not self._initialized then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 4-6, warpins: 1 ---
		return self:_not_initialized()
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 7-9, warpins: 1 ---
	if self._auth_cache and not self._auth_cache:is_rejected() then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 16-17, warpins: 1 ---
		return self._auth_cache
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 18-32, warpins: 2 ---
	local promise = Promise:new()
	local user_id = Managers.account:user_id()
	local operation_identifier, error = Backend.authenticate(user_id)

	if operation_identifier then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 33-36, warpins: 1 ---
		self._promises[operation_identifier] = promise
		self._auth_cache = promise
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 37-38, warpins: 1 ---
		error = error or "Missing backend operation identifier"

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 40-48, warpins: 2 ---
		promise:reject(BackendUtilities.create_error(BackendError.NoIdentifier, error))
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 49-54, warpins: 2 ---
	promise:next(function (account)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-10, warpins: 1 ---
		Managers.telemetry_events:player_authenticated(account)

		if Managers.event then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 11-16, warpins: 1 ---
			Managers.event:trigger("event_player_authenticated")
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 17-19, warpins: 2 ---
		if not DEDICATED_SERVER then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 20-30, warpins: 1 ---
			Managers.telemetry_events:system_settings()
			self.interfaces.region_latency:refresh_region_latencies()
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #1 ---

		FLOW; TARGET BLOCK #2



		-- Decompilation error in this vicinity:
		--- BLOCK #2 31-31, warpins: 2 ---
		return
		--- END OF BLOCK #2 ---



	end)

	return promise
	--- END OF BLOCK #3 ---

	FLOW; TARGET BLOCK #4



	-- Decompilation error in this vicinity:
	--- BLOCK #4 55-55, warpins: 2 ---
	--- END OF BLOCK #4 ---

	FLOW; TARGET BLOCK #5



	-- Decompilation error in this vicinity:
	--- BLOCK #5 56-56, warpins: 2 ---
	--- END OF BLOCK #5 ---



end

BackendManager.AUTH_METHOD_XBOXLIVE = Backend.AUTH_METHOD_XBOXLIVE
BackendManager.AUTH_METHOD_STEAM = Backend.AUTH_METHOD_STEAM

BackendManager.get_auth_method = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	return Backend.get_auth_method()
	--- END OF BLOCK #0 ---



end

BackendManager.account_id = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	if self._auth_cache and self._auth_cache.value and self._auth_cache.value.sub then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 13-16, warpins: 1 ---
		return self._auth_cache.value.sub
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 17-18, warpins: 4 ---
	return nil
	--- END OF BLOCK #1 ---



end

BackendManager.title_request = function (self, path, options)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-6, warpins: 1 ---
	Log.info("BackendManager", "title_request: %s %s", (options and options.method) or "GET", path)
	assert(type(path) == "string", "Invalid path")

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 11-18, warpins: 2 ---
	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 22-26, warpins: 2 ---
	if not self._initialized then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 27-29, warpins: 1 ---
		return self:_not_initialized()
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 30-31, warpins: 1 ---
	local should_cache = not options or options.method == "GET"

	--- END OF BLOCK #3 ---

	FLOW; TARGET BLOCK #4



	-- Decompilation error in this vicinity:
	--- BLOCK #4 38-39, warpins: 2 ---
	if should_cache then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 40-43, warpins: 1 ---
		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 44-60, warpins: 0 ---
		for key, value in pairs(self._inflight_title_requests) do

			-- Decompilation error in this vicinity:
			--- BLOCK #0 44-46, warpins: 1 ---
			if value.should_cache and value.path == path then

				-- Decompilation error in this vicinity:
				--- BLOCK #0 50-53, warpins: 1 ---
				--- END OF BLOCK #0 ---

				FLOW; TARGET BLOCK #1



				-- Decompilation error in this vicinity:
				--- BLOCK #1 54-58, warpins: 0 ---
				for promise_key, promise in pairs(self._promises) do

					-- Decompilation error in this vicinity:
					--- BLOCK #0 54-55, warpins: 1 ---
					if key == promise_key then

						-- Decompilation error in this vicinity:
						--- BLOCK #0 56-56, warpins: 1 ---
						return promise
						--- END OF BLOCK #0 ---



					end
					--- END OF BLOCK #0 ---

					FLOW; TARGET BLOCK #1



					-- Decompilation error in this vicinity:
					--- BLOCK #1 57-58, warpins: 2 ---
					--- END OF BLOCK #1 ---



				end
				--- END OF BLOCK #1 ---



			end
			--- END OF BLOCK #0 ---

			FLOW; TARGET BLOCK #1



			-- Decompilation error in this vicinity:
			--- BLOCK #1 59-60, warpins: 4 ---
			--- END OF BLOCK #1 ---



		end
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #4 ---

	FLOW; TARGET BLOCK #5



	-- Decompilation error in this vicinity:
	--- BLOCK #5 61-62, warpins: 2 ---
	options = options or {}
	--- END OF BLOCK #5 ---

	FLOW; TARGET BLOCK #6



	-- Decompilation error in this vicinity:
	--- BLOCK #6 64-66, warpins: 2 ---
	options.headers = options.headers or {}
	local default_headers = self._default_headers_ctr()

	--- END OF BLOCK #6 ---

	FLOW; TARGET BLOCK #7



	-- Decompilation error in this vicinity:
	--- BLOCK #7 68-72, warpins: 2 ---
	if default_headers then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 73-77, warpins: 1 ---
		table.merge(options.headers, default_headers)
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #7 ---

	FLOW; TARGET BLOCK #8



	-- Decompilation error in this vicinity:
	--- BLOCK #8 78-88, warpins: 2 ---
	local promise = Promise:new()
	local operation_identifier, error = Backend.title_request(path, options)

	if operation_identifier then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 89-106, warpins: 1 ---
		self._promises[operation_identifier] = promise
		self._inflight_title_requests[operation_identifier] = {
			retry_count = 0,
			path = path,
			options = options,
			should_cache = should_cache,
			operation_identifier = operation_identifier
		}

		promise:next(function (v)

			-- Decompilation error in this vicinity:
			--- BLOCK #0 1-10, warpins: 1 ---
			self._inflight_title_requests[operation_identifier] = nil

			_check_response_time(path, v)

			return
			--- END OF BLOCK #0 ---



		end):catch(function (e)

			-- Decompilation error in this vicinity:
			--- BLOCK #0 1-10, warpins: 1 ---
			self._inflight_title_requests[operation_identifier] = nil

			_check_response_time(path, e)

			return
			--- END OF BLOCK #0 ---



		end)
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 107-108, warpins: 1 ---
		error = error or "Missing backend operation identifier"

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 110-118, warpins: 2 ---
		promise:reject(BackendUtilities.create_error(BackendError.NoIdentifier, error))
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #8 ---

	FLOW; TARGET BLOCK #9



	-- Decompilation error in this vicinity:
	--- BLOCK #9 119-120, warpins: 2 ---
	return promise
	--- END OF BLOCK #9 ---

	FLOW; TARGET BLOCK #10



	-- Decompilation error in this vicinity:
	--- BLOCK #10 121-121, warpins: 2 ---
	--- END OF BLOCK #10 ---

	FLOW; TARGET BLOCK #11



	-- Decompilation error in this vicinity:
	--- BLOCK #11 122-122, warpins: 2 ---
	--- END OF BLOCK #11 ---



end

BackendManager.send_telemetry_events = function (self, data, headers, compress_body)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	if not self._initialized then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 4-6, warpins: 1 ---
		return self:_not_initialized()
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 7-8, warpins: 2 ---
	data = data or {}
	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 10-22, warpins: 2 ---
	local promise = Promise:new()
	local operation_identifier, error = Backend.send_telemetry_events({
		events = data
	}, headers, compress_body)

	if operation_identifier then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 23-25, warpins: 1 ---
		self._promises[operation_identifier] = promise
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 26-27, warpins: 1 ---
		error = error or "Missing backend operation identifier"

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 29-37, warpins: 2 ---
		promise:reject(BackendUtilities.create_error(BackendError.NoIdentifier, error))
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 38-38, warpins: 2 ---
	return promise
	--- END OF BLOCK #3 ---



end

BackendManager.url_request = function (self, url, options)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-6, warpins: 1 ---
	assert(type(url) == "string", "Invalid url")
	Log.info("BackendManager", "url_request: %s %s", (options and options.method) or "GET", url)

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 10-17, warpins: 2 ---
	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 22-26, warpins: 2 ---
	if not self._initialized then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 27-29, warpins: 1 ---
		return self:_not_initialized()
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 30-40, warpins: 1 ---
	local promise = Promise:new()
	local operation_identifier, error = Backend.url_request(url, options)

	if operation_identifier then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 41-43, warpins: 1 ---
		self._promises[operation_identifier] = promise
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 44-45, warpins: 1 ---
		error = error or "Missing backend operation identifier"

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 47-55, warpins: 2 ---
		promise:reject(BackendUtilities.create_error(BackendError.NoIdentifier, error))
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #3 ---

	FLOW; TARGET BLOCK #4



	-- Decompilation error in this vicinity:
	--- BLOCK #4 56-65, warpins: 2 ---
	promise:next(function (v)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-5, warpins: 1 ---
		_check_response_time(url, v)

		return
		--- END OF BLOCK #0 ---



	end):catch(function (e)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-5, warpins: 1 ---
		_check_response_time(url, e)

		return
		--- END OF BLOCK #0 ---



	end)

	return promise
	--- END OF BLOCK #4 ---

	FLOW; TARGET BLOCK #5



	-- Decompilation error in this vicinity:
	--- BLOCK #5 66-66, warpins: 2 ---
	--- END OF BLOCK #5 ---



end

BackendManager._not_initialized = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-14, warpins: 1 ---
	local p = Promise:new()

	p:reject(BackendUtilities.create_error(BackendError.NotInitialized, "Backend not initialized"))

	return p
	--- END OF BLOCK #0 ---



end

BackendManager.sync_time = function (self, t)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-5, warpins: 1 ---
	if self.time_sync_state == TIME_SYNC_STATES.synced then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 6-7, warpins: 1 ---
		return
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 8-12, warpins: 1 ---
		if self.time_sync_state == TIME_SYNC_STATES.failed then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 13-17, warpins: 1 ---
			if TIME_SYNC_PAUSE_BETWEEN_RETRY_SECONDS < t - self.time_sync_started_t then

				-- Decompilation error in this vicinity:
				--- BLOCK #0 18-28, warpins: 1 ---
				Log.debug("Backend", "Time sync ready for retry")

				self.time_sync_state = TIME_SYNC_STATES.not_started
				self.time_sync_started_t = nil
				--- END OF BLOCK #0 ---



			end
			--- END OF BLOCK #0 ---



		else

			-- Decompilation error in this vicinity:
			--- BLOCK #0 29-33, warpins: 1 ---
			if self.time_sync_state == TIME_SYNC_STATES.not_started then

				-- Decompilation error in this vicinity:
				--- BLOCK #0 34-38, warpins: 1 ---
				if not self:authenticated() then

					-- Decompilation error in this vicinity:
					--- BLOCK #0 39-39, warpins: 1 ---
					return
					--- END OF BLOCK #0 ---



				end

				--- END OF BLOCK #0 ---

				FLOW; TARGET BLOCK #1



				-- Decompilation error in this vicinity:
				--- BLOCK #1 40-51, warpins: 2 ---
				Log.info("Backend", "Starting time sync")

				self.time_sync_started_t = t
				local operation_identifier, error = Backend.title_request("/data/time")

				if error then

					-- Decompilation error in this vicinity:
					--- BLOCK #0 52-55, warpins: 1 ---
					self.time_sync_state = TIME_SYNC_STATES.failed

					return
					--- END OF BLOCK #0 ---



				end

				--- END OF BLOCK #1 ---

				FLOW; TARGET BLOCK #2



				-- Decompilation error in this vicinity:
				--- BLOCK #2 56-59, warpins: 2 ---
				self.time_sync_state = TIME_SYNC_STATES.running
				self.time_operation_id = operation_identifier
				--- END OF BLOCK #2 ---



			end
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 60-60, warpins: 5 ---
	return
	--- END OF BLOCK #1 ---



end

BackendManager.sync_time_result = function (self, t, id, mapping)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-5, warpins: 1 ---
	if self.time_sync_state ~= TIME_SYNC_STATES.running or self.time_operation_id ~= id then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 9-9, warpins: 2 ---
		return
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 10-12, warpins: 2 ---
	if mapping.error then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 13-24, warpins: 1 ---
		Log.debug("Backend", "Time sync failed")

		self.time_sync_state = TIME_SYNC_STATES.failed

		if mapping.error.status == 404 then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 25-28, warpins: 1 ---
			self.time_sync_state = TIME_SYNC_STATES.synced
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 29-41, warpins: 1 ---
		local latency = t - self.time_sync_started_t
		local body = mapping.value.body

		Log.debug("Backend", "Time sync latency: %.2f", latency)

		if TIME_SYNC_ACCEPTABLE_LATENCY_SECONDS < latency or body.coldStart then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 45-48, warpins: 2 ---
			self.time_sync_state = TIME_SYNC_STATES.failed
			--- END OF BLOCK #0 ---



		else

			-- Decompilation error in this vicinity:
			--- BLOCK #0 49-51, warpins: 1 ---
			self.time_sync_state = TIME_SYNC_STATES.synced
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 52-57, warpins: 2 ---
		self.server_time_game_start_epoch = tonumber(body.time) - t * 1000
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 58-58, warpins: 3 ---
	return
	--- END OF BLOCK #2 ---



end

BackendManager.get_server_time = function (self, t)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	if self.server_time_game_start_epoch then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 4-8, warpins: 1 ---
		return self.server_time_game_start_epoch + t * 1000
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 9-13, warpins: 1 ---
		return os.time() * 1000
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 14-14, warpins: 2 ---
	return
	--- END OF BLOCK #1 ---



end

BackendManager._time_sync_restart = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-8, warpins: 1 ---
	self.server_time_game_start_epoch = nil
	self.time_sync_started_t = nil
	self.time_sync_state = TIME_SYNC_STATES.not_started

	return
	--- END OF BLOCK #0 ---



end

BackendManager.failed_request = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-10, warpins: 1 ---
	return Promise.delay(LIMIT_RESPONSE_TIME_WARNING_MS / 1000):next(function (_)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-9, warpins: 1 ---
		return Promise.rejected(BackendUtilities.create_error(BackendError.NoIdentifier, "Requested failure"))
		--- END OF BLOCK #0 ---



	end)
	--- END OF BLOCK #0 ---



end

implements(BackendManager, Interface)

return BackendManager
