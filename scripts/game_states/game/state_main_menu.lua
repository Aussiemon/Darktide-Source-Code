-- Decompilation Error: _glue_flows(node)

-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
local CharacterCreate = require("scripts/utilities/character_create")
local MasterItems = require("scripts/backend/master_items")
local Promise = require("scripts/foundation/utilities/promise")
local StateMainMenuTestify = GameParameters.testify and require("scripts/game_states/game/state_main_menu_testify")
local FIRST_ONBOARDING_MISSION = "prologue"
local StateMainMenu = class("StateMainMenu")

StateMainMenu.on_enter = function (self, parent, params, creation_context)
	self._creation_context = creation_context
	local profiles = params.profiles
	local selected_profile = params.selected_profile
	local has_created_first_character = params.has_created_first_character
	local main_menu_loader = params.main_menu_loader
	self._main_menu_loader = main_menu_loader
	self._is_booting = params.is_booting or false
	self._item_definitions = MasterItems.get_cached()
	self._wait_for_character_profile_upload = false
	self._wait_for_character_profile_delete = false
	self._wait_for_character_profiles_refresh = false
	self._profiles = {}
	self._selected_profile = nil
	self._character_is_syncing = false

	Managers.presence:set_presence("main_menu")
	fassert(profiles, "StateMainMenu expects preloaded profiles")
	fassert(main_menu_loader, "StateMainMenu expects preloaded main_menu_loader")
	self:_register_menu_events()

	if has_created_first_character or #profiles > 0 then
		self:_stay_in_main_menu(profiles, selected_profile)
	elseif GameParameters.skip_first_character_creation then
		self:_stay_in_main_menu(profiles, selected_profile)
	else
		self._force_create_first_character = true

		self:_create_new_character_start()
	end

	self._reconnect_popup_activated = true
end

StateMainMenu._stay_in_main_menu = function (self, profiles, selected_profile)
	self:_set_view_state_cb("main_menu")
	self:_set_profiles(profiles)
	self:_set_selected_profile(selected_profile)
end

StateMainMenu._register_menu_events = function (self)
	local event_manager = Managers.event

	event_manager:register(self, "event_state_main_menu_continue", "event_continue_cb")
	event_manager:register(self, "event_create_new_character_start", "event_create_new_character_start")
	event_manager:register(self, "event_create_new_character_continue", "event_create_new_character_continue")
	event_manager:register(self, "event_create_new_character_back", "event_create_new_character_back")
	event_manager:register(self, "event_request_select_new_profile", "event_request_select_new_profile")
	event_manager:register(self, "event_request_delete_character", "event_request_delete_character")
	event_manager:register(self, "event_main_menu_entered", "event_main_menu_entered")

	self._events_registered = true
end

StateMainMenu._unregister_menu_events = function (self)
	if self._events_registered then
		local event_manager = Managers.event

		event_manager:unregister(self, "event_state_main_menu_continue")
		event_manager:unregister(self, "event_create_new_character_start")
		event_manager:unregister(self, "event_create_new_character_back")
		event_manager:unregister(self, "event_create_new_character_continue")
		event_manager:unregister(self, "event_request_select_new_profile")
		event_manager:unregister(self, "event_request_delete_character")
		event_manager:unregister(self, "event_main_menu_entered")

		self._events_registered = nil
	end
end

StateMainMenu.event_request_select_new_profile = function (self, profile)
	if profile ~= self._selected_profile then
		self:_set_selected_profile(profile)
	end
end

StateMainMenu.event_request_delete_character = function (self, character_id)
	local selected_profile = self._selected_profile

	fassert(selected_profile and selected_profile.character_id == character_id, "Tried to delete character that is not selected in StateMainMenu")

	self._wait_for_character_profile_delete = true

	Managers.data_service.profiles:delete_profile(character_id):next(function ()
		self._wait_for_character_profile_delete = false

		self:_refresh_profiles()
	end):catch(function ()
		self._wait_for_character_profile_delete = false

		self:_set_selected_profile(nil)
	end)
end

StateMainMenu.event_main_menu_entered = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-15, warpins: 1 ---
	Managers.event:trigger("event_main_menu_profiles_changed", self._profiles)
	Managers.event:trigger("event_main_menu_selected_profile_changed", self._selected_profile)

	return
	--- END OF BLOCK #0 ---



end

StateMainMenu.event_create_new_character_start = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	self:_create_new_character_start()

	return
	--- END OF BLOCK #0 ---



end

StateMainMenu.event_create_new_character_continue = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	self:_next_character_create_view()

	return
	--- END OF BLOCK #0 ---



end

StateMainMenu.event_create_new_character_back = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	self:_previous_character_create_view()

	return
	--- END OF BLOCK #0 ---



end

StateMainMenu.event_continue_cb = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	local selected_profile = self._selected_profile

	if not selected_profile then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 4-9, warpins: 1 ---
		Log.warning("StateMainMenu", "Tried start game without a selected character!")

		return
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 10-55, warpins: 1 ---
	local character_id = selected_profile.character_id

	Log.info("StateMainMenu", "Starting the game with selected character %s", character_id)
	self:_unregister_menu_events()

	local prologue_completed_promise = Managers.data_service.profiles:prologue_completed(character_id)
	local set_selected_character_promise = Managers.data_service.account:set_selected_character_id(character_id)
	local load_narrative_promise = Managers.narrative:load_character_narrative(character_id)

	Promise.all(prologue_completed_promise, set_selected_character_promise, load_narrative_promise):next(function (results)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-5, warpins: 1 ---
		local prologue_completed, _, _ = unpack(results)

		if prologue_completed or self:_skip_prologue() then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 12-16, warpins: 2 ---
			self:_start_game()
			--- END OF BLOCK #0 ---



		else

			-- Decompilation error in this vicinity:
			--- BLOCK #0 17-22, warpins: 1 ---
			local mission_name = FIRST_ONBOARDING_MISSION

			self:_start_onboarding(mission_name)
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 23-23, warpins: 2 ---
		return
		--- END OF BLOCK #1 ---



	end):catch(function ()

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-1, warpins: 1 ---
		return
		--- END OF BLOCK #0 ---



	end)

	return
	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 56-56, warpins: 2 ---
	--- END OF BLOCK #2 ---



end

StateMainMenu._skip_prologue = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	return GameParameters.skip_prologue
	--- END OF BLOCK #0 ---



end

StateMainMenu._refresh_profiles = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-18, warpins: 1 ---
	self._wait_for_character_profiles_refresh = true

	Managers.data_service.profiles:fetch_all_profiles():next(function (profile_data)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-16, warpins: 1 ---
		self._wait_for_character_profiles_refresh = false
		local profiles = profile_data.profiles
		local selected_profile = profile_data.selected_profile

		self:_set_profiles(profiles)
		self:_set_selected_profile(selected_profile)

		return
		--- END OF BLOCK #0 ---



	end):catch(function ()

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-4, warpins: 1 ---
		self._wait_for_character_profiles_refresh = false

		return
		--- END OF BLOCK #0 ---



	end)

	return
	--- END OF BLOCK #0 ---



end

StateMainMenu._set_profiles = function (self, profiles)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-9, warpins: 1 ---
	self._profiles = profiles

	Managers.event:trigger("event_main_menu_profiles_changed", profiles)

	return
	--- END OF BLOCK #0 ---



end

local function _set_player_profile(profile)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-12, warpins: 1 ---
	local local_player_id = 1
	local local_player = Managers.player:local_player(local_player_id)

	local_player:set_profile(profile)

	return
	--- END OF BLOCK #0 ---



end

StateMainMenu._set_selected_profile = function (self, profile)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-12, warpins: 1 ---
	_set_player_profile(profile)

	self._selected_profile = profile

	Managers.event:trigger("event_main_menu_selected_profile_changed", profile)

	return
	--- END OF BLOCK #0 ---



end

StateMainMenu._create_new_character_start = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-7, warpins: 1 ---
	self:_set_view_state_cb("character_create")

	if not self._character_create then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 8-19, warpins: 1 ---
		self._character_create_state_views = {
			{
				"class_selection_view"
			},
			{
				"character_appearance_view"
			}
		}
		self._character_create = CharacterCreate:new(self._item_definitions)
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 20-30, warpins: 2 ---
	self:_next_character_create_view()
	Managers.time:register_timer("character_creation_timer", "main")

	return
	--- END OF BLOCK #1 ---



end

StateMainMenu.in_character_create_state = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	return self._character_create ~= nil
	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 7-7, warpins: 2 ---
	--- END OF BLOCK #1 ---



end

StateMainMenu._waiting_for_profile_synchronization = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	if self._wait_for_character_profile_upload or self._wait_for_character_profile_delete or self._wait_for_character_profiles_refresh then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 10-12, warpins: 3 ---
		return true
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 13-14, warpins: 1 ---
		return false
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 15-15, warpins: 2 ---
	return
	--- END OF BLOCK #1 ---



end

StateMainMenu.waiting_for_profile_synchronization = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	return self:_waiting_for_profile_synchronization()
	--- END OF BLOCK #0 ---



end

StateMainMenu._previous_character_create_view = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	local views_index = (self._current_character_create_state_views_index or 1) - 1
	local success = self:_open_character_create_state_views(views_index)

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 5-11, warpins: 2 ---
	if not success then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 12-14, warpins: 1 ---
		if self._force_create_first_character then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 15-19, warpins: 1 ---
			Log.warning("StateMainMenu", "Skipped character creation when force_create_first_character = true")
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 20-58, warpins: 2 ---
		self._character_create_state_views = nil

		self._character_create:destroy()

		self._character_create = nil
		self._current_character_create_state_views_index = nil

		self:_set_view_state_cb("main_menu")
		Managers.event:trigger("event_main_menu_profiles_changed", self._profiles)
		Managers.event:trigger("event_main_menu_selected_profile_changed", self._selected_profile)
		Managers.time:unregister_timer("character_creation_timer")
		Log.info("StateMainMenu", "Exit character creator")
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 59-59, warpins: 2 ---
	return
	--- END OF BLOCK #2 ---



end

StateMainMenu._next_character_create_view = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	local views_index = (self._current_character_create_state_views_index or 0) + 1
	local success = self:_open_character_create_state_views(views_index)

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 5-11, warpins: 2 ---
	if not success then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 12-17, warpins: 1 ---
		self._character_create:upload_profile()

		self._wait_for_character_profile_upload = true
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 18-18, warpins: 2 ---
	return
	--- END OF BLOCK #2 ---



end

StateMainMenu._on_profile_create_completed = function (self, created_profile)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-14, warpins: 1 ---
	self._character_create_state_views = nil

	self._character_create:destroy()

	self._character_create = nil
	self._current_character_create_state_views_index = nil
	self._wait_for_character_profile_upload = false

	if created_profile then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 15-59, warpins: 1 ---
		local time = Managers.time:time("character_creation_timer")

		Managers.telemetry_events:character_creation_time(created_profile.character_id, time)
		Managers.time:unregister_timer("character_creation_timer")
		Log.info("StateMainMenu", "Time in character creator %s", time)

		local character_id = created_profile.character_id
		local promises = {}
		promises[1] = Managers.data_service.account:set_selected_character_id(character_id)
		promises[2] = Managers.narrative:load_character_narrative(character_id)

		if self._force_create_first_character then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 60-68, warpins: 1 ---
			self._force_create_first_character = nil
			promises[3] = Managers.data_service.account:set_has_created_first_character()
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 69-83, warpins: 2 ---
		Promise.all(unpack(promises)):next(function ()

			-- Decompilation error in this vicinity:
			--- BLOCK #0 1-6, warpins: 1 ---
			if self:_skip_prologue() then

				-- Decompilation error in this vicinity:
				--- BLOCK #0 7-23, warpins: 1 ---
				_set_player_profile(created_profile)

				local character_id = created_profile.character_id

				Managers.data_service.account:set_selected_character_id(character_id)
				self:_start_game()
				--- END OF BLOCK #0 ---



			else

				-- Decompilation error in this vicinity:
				--- BLOCK #0 24-31, warpins: 1 ---
				_set_player_profile(created_profile)
				self:_start_onboarding(FIRST_ONBOARDING_MISSION)
				--- END OF BLOCK #0 ---



			end

			--- END OF BLOCK #0 ---

			FLOW; TARGET BLOCK #1



			-- Decompilation error in this vicinity:
			--- BLOCK #1 32-32, warpins: 2 ---
			return
			--- END OF BLOCK #1 ---



		end):catch(function ()

			-- Decompilation error in this vicinity:
			--- BLOCK #0 1-6, warpins: 1 ---
			self:_set_view_state_cb("main_menu")

			return
			--- END OF BLOCK #0 ---



		end)
		--- END OF BLOCK #1 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 84-93, warpins: 1 ---
		Managers.time:unregister_timer("character_creation_timer")
		self:_set_view_state_cb("main_menu")
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 94-95, warpins: 2 ---
	return
	--- END OF BLOCK #1 ---



end

StateMainMenu._close_current_character_create_state_views = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	if self._current_character_create_state_views then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 4-8, warpins: 1 ---
		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 9-17, warpins: 0 ---
		for i = 1, #self._current_character_create_state_views, 1 do

			-- Decompilation error in this vicinity:
			--- BLOCK #0 9-17, warpins: 2 ---
			local next_view = self._current_character_create_state_views[i]

			Managers.ui:close_view(next_view)
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #1 ---

		FLOW; TARGET BLOCK #2



		-- Decompilation error in this vicinity:
		--- BLOCK #2 18-19, warpins: 1 ---
		self._current_character_create_state_views = nil
		--- END OF BLOCK #2 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 20-20, warpins: 2 ---
	return
	--- END OF BLOCK #1 ---



end

StateMainMenu._open_character_create_state_views = function (self, index)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-8, warpins: 1 ---
	self:_close_current_character_create_state_views()

	local view_index = index
	local next_views = self._character_create_state_views[view_index]

	if next_views then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 9-18, warpins: 1 ---
		local view_context = {}
		view_context.character_create = self._character_create
		view_context.parent = self
		view_context.force_character_creation = self._force_create_first_character

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 19-30, warpins: 0 ---
		for i = 1, #next_views, 1 do

			-- Decompilation error in this vicinity:
			--- BLOCK #0 19-30, warpins: 2 ---
			local next_view = next_views[i]

			Managers.ui:open_view(next_view, nil, nil, nil, nil, view_context)

			self._current_character_create_state_views = next_views
			self._current_character_create_state_views_index = view_index
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #1 ---

		FLOW; TARGET BLOCK #2



		-- Decompilation error in this vicinity:
		--- BLOCK #2 31-32, warpins: 1 ---
		return true
		--- END OF BLOCK #2 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 33-34, warpins: 2 ---
	return false
	--- END OF BLOCK #1 ---



end

local state_views = {
	main_menu = {
		"main_menu_background_view"
	}
}

StateMainMenu._close_current_state_views = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-5, warpins: 1 ---
	local current_view_state = self._current_view_state
	local open_views = state_views[current_view_state]

	if open_views then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 6-9, warpins: 1 ---
		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 10-17, warpins: 0 ---
		for i = 1, #open_views, 1 do

			-- Decompilation error in this vicinity:
			--- BLOCK #0 10-17, warpins: 2 ---
			local view_name = open_views[i]

			Managers.ui:close_view(view_name)
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 18-18, warpins: 2 ---
	return
	--- END OF BLOCK #1 ---



end

StateMainMenu._set_view_state_cb = function (self, state)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-8, warpins: 1 ---
	self:_close_current_state_views()

	self._current_view_state = state
	local new_state_views = state_views[state]

	if new_state_views then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 9-14, warpins: 1 ---
		local view_context = {}
		view_context.parent = self

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 15-24, warpins: 0 ---
		for i = 1, #new_state_views, 1 do

			-- Decompilation error in this vicinity:
			--- BLOCK #0 15-24, warpins: 2 ---
			local view_name = new_state_views[i]

			Managers.ui:open_view(view_name, nil, nil, nil, nil, view_context)
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 25-26, warpins: 2 ---
	if state == "main_menu" and self._is_booting then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 30-32, warpins: 1 ---
		self:_should_open_news()
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 33-33, warpins: 3 ---
	return
	--- END OF BLOCK #2 ---



end

StateMainMenu._start_game = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-10, warpins: 1 ---
	self:_unregister_menu_events()
	self:_set_view_state_cb(nil)

	self._continue = true

	return
	--- END OF BLOCK #0 ---



end

StateMainMenu.update = function (self, main_dt, main_t)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	local ui_manager = Managers.ui

	if ui_manager then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 5-7, warpins: 1 ---
		ui_manager:handle_view_hotkeys()
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 8-11, warpins: 2 ---
	local session_in_progress = GameParameters.prod_like_backend and Managers.party_immaterium:game_session_in_progress()

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 17-19, warpins: 2 ---
	if not self._reconnect_pressed and self._reconnect_popup_activated and session_in_progress then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 25-27, warpins: 1 ---
		if not self._reconnect_popup_id then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 28-31, warpins: 1 ---
			self:_show_reconnect_popup()
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 32-34, warpins: 3 ---
		if self._reconnect_popup_id then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 35-43, warpins: 1 ---
			Managers.event:trigger("event_remove_ui_popup", self._reconnect_popup_id)

			self._reconnect_popup_id = nil
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 44-46, warpins: 4 ---
	if self._wait_for_character_profile_upload then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 47-52, warpins: 1 ---
		local character_create = self._character_create

		if character_create:completed() then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 53-58, warpins: 1 ---
			local success = not character_create:failed()
			local created_profile = success and character_create:created_character_profile()

			--- END OF BLOCK #0 ---

			FLOW; TARGET BLOCK #1



			-- Decompilation error in this vicinity:
			--- BLOCK #1 62-65, warpins: 2 ---
			self:_on_profile_create_completed(created_profile)
			--- END OF BLOCK #1 ---



		end
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #3 ---

	FLOW; TARGET BLOCK #4



	-- Decompilation error in this vicinity:
	--- BLOCK #4 66-78, warpins: 3 ---
	local context = self._creation_context

	context.network_receive_function(main_dt)
	context.network_transmit_function()

	local error_state, error_state_params = Managers.error:wanted_transition()

	if error_state then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 79-82, warpins: 1 ---
		return error_state, error_state_params
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 83-85, warpins: 1 ---
		if IS_XBS then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 86-92, warpins: 1 ---
			local error_state, error_state_params = Managers.account:wanted_transition()

			if error_state then

				-- Decompilation error in this vicinity:
				--- BLOCK #0 93-95, warpins: 1 ---
				return error_state, error_state_params
				--- END OF BLOCK #0 ---



			end
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #4 ---

	FLOW; TARGET BLOCK #5



	-- Decompilation error in this vicinity:
	--- BLOCK #5 96-101, warpins: 4 ---
	local is_syncing = self:_waiting_for_profile_synchronization()

	if self._continue and not is_syncing then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 104-117, warpins: 1 ---
		fassert(Managers.narrative:is_narrative_loaded_for_player_character(), "Narrative data not loaded for current player character")

		self._reconnect_pressed = false
		local next_state, state_context = nil

		if self._onboarding_mission_name then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 118-126, warpins: 1 ---
			next_state, state_context = Managers.multiplayer_session:start_singleplayer_session(self._onboarding_mission_name)
			--- END OF BLOCK #0 ---



		else

			-- Decompilation error in this vicinity:
			--- BLOCK #0 127-133, warpins: 1 ---
			next_state, state_context = Managers.multiplayer_session:find_available_session()
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 134-136, warpins: 2 ---
		return next_state, state_context
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #5 ---

	FLOW; TARGET BLOCK #6



	-- Decompilation error in this vicinity:
	--- BLOCK #6 137-139, warpins: 3 ---
	if is_syncing ~= self._character_is_syncing then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 140-147, warpins: 1 ---
		Managers.event:trigger("update_character_sync_state", is_syncing)

		self._character_is_syncing = is_syncing
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #6 ---

	FLOW; TARGET BLOCK #7



	-- Decompilation error in this vicinity:
	--- BLOCK #7 148-151, warpins: 2 ---
	if GameParameters.testify then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 152-157, warpins: 1 ---
		Testify:poll_requests_through_handler(StateMainMenuTestify, self)
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #7 ---

	FLOW; TARGET BLOCK #8



	-- Decompilation error in this vicinity:
	--- BLOCK #8 158-158, warpins: 2 ---
	return
	--- END OF BLOCK #8 ---



end

StateMainMenu._start_onboarding = function (self, mission_name)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-5, warpins: 1 ---
	self._onboarding_mission_name = mission_name

	self:_start_game()

	return
	--- END OF BLOCK #0 ---



end

StateMainMenu._should_open_news = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-9, warpins: 1 ---
	local save_manager = Managers.save
	local save_data = save_manager:account_data()
	local news_feed_enabled = save_data.interface_settings.news_enabled

	if news_feed_enabled then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 10-15, warpins: 1 ---
		Managers.event:trigger("event_main_menu_load_news")
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 16-16, warpins: 2 ---
	return
	--- END OF BLOCK #1 ---



end

StateMainMenu.on_exit = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-12, warpins: 1 ---
	self:_close_current_character_create_state_views()
	self:_close_current_state_views()
	self:_unregister_menu_events()

	if self._main_menu_loader then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 13-18, warpins: 1 ---
		self._main_menu_loader:destroy()

		self._main_menu_loader = nil
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 19-19, warpins: 2 ---
	return
	--- END OF BLOCK #1 ---



end

StateMainMenu._rejoin_game = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	local selected_profile = self._selected_profile

	if not selected_profile then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 4-9, warpins: 1 ---
		Log.warning("StateMainMenu", "Tried to rejoin a game without a selected character!")

		return
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 10-47, warpins: 1 ---
	local character_id = selected_profile.character_id

	Log.info("StateMainMenu", "Rejoining the game with selected character %s", character_id)
	self:_unregister_menu_events()

	local set_selected_character_promise = Managers.data_service.account:set_selected_character_id(character_id)
	local load_narrative_promise = Managers.narrative:load_character_narrative(character_id)

	Promise.all(set_selected_character_promise, load_narrative_promise):next(function (_)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-5, warpins: 1 ---
		self:_start_game()

		return
		--- END OF BLOCK #0 ---



	end):catch(function ()

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-1, warpins: 1 ---
		return
		--- END OF BLOCK #0 ---



	end)

	return
	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 48-48, warpins: 2 ---
	--- END OF BLOCK #2 ---



end

StateMainMenu._show_reconnect_popup = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-21, warpins: 1 ---
	local context = {
		title_text = "loc_popup_header_reconnect_to_session",
		description_text = "loc_popup_description_reconnect_to_session"
	}
	context.options = {
		{
			text = "loc_popup_reconnect_to_session_reconnect_button",
			close_on_pressed = true,
			hotkey = "confirm_pressed",
			callback = function ()

				-- Decompilation error in this vicinity:
				--- BLOCK #0 1-11, warpins: 1 ---
				self._reconnect_popup_id = nil
				self._reconnect_pressed = true

				self:_rejoin_game()

				return
				--- END OF BLOCK #0 ---



			end
		},
		{
			text = "loc_popup_reconnect_to_session_leave_button",
			close_on_pressed = true,
			hotkey = "back",
			callback = function ()

				-- Decompilation error in this vicinity:
				--- BLOCK #0 1-6, warpins: 1 ---
				Managers.party_immaterium:leave_party()

				return
				--- END OF BLOCK #0 ---



			end
		}
	}

	Managers.event:trigger("event_show_ui_popup", context, function (id)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-3, warpins: 1 ---
		self._reconnect_popup_id = id

		return
		--- END OF BLOCK #0 ---



	end)

	return
	--- END OF BLOCK #0 ---



end

return StateMainMenu
