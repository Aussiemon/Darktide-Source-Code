-- Decompilation Error: _glue_flows(node)

-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
local BackendInterface = require("scripts/backend/backend_interface")
local MatchmakingConstants = require("scripts/settings/network/matchmaking_constants")
local DummySessionReport = require("scripts/managers/progression/dummy_session_report")
local Progression = require("scripts/backend/progression")
local MasterItems = require("scripts/backend/master_items")
local Promise = require("scripts/foundation/utilities/promise")
local ItemUtils = require("scripts/utilities/items")

local function _info(...)
	Log.info("ProgressManager", ...)
end

local ProgressionManager = class("ProgressionManager")
local FETCH_DUMMY_SESSION_REPORT = false
local FETCH_DUMMY_SESSION_REPORT_DELAY = {
	max = 5,
	min = 0
}
local SESSION_REPORT_STATES = table.enum("none", "fetching", "success", "fail")
local SET_TRAITS_STATES = table.enum("none", "updating", "success", "fail")

ProgressionManager.init = function (self)
	self._backend_interface = BackendInterface:new()
	self._progression = Progression:new()
	self._session_report_state = SESSION_REPORT_STATES.none
	self._set_traits_state = SET_TRAITS_STATES.none
end

ProgressionManager.destroy = function (self)
	return
end

ProgressionManager.is_fetching_session_report = function (self)
	return self._session_report_state == SESSION_REPORT_STATES.fetching
end

ProgressionManager.session_report_success = function (self)
	return self._session_report_state == SESSION_REPORT_STATES.success
end

ProgressionManager.fetch_session_report = function (self, session_id)
	self._session_report = {
		team = {},
		character = {}
	}
	self._session_report.character.rewards = {}
	self._session_report.account = {
		rewards = {}
	}
	self._session_report.weapon = {}
	self._session_report_state = SESSION_REPORT_STATES.fetching
	local host_type = Managers.multiplayer_session:host_type()

	if host_type ~= MatchmakingConstants.HOST_TYPES.mission_server then
		FETCH_DUMMY_SESSION_REPORT = true
	end

	if GameParameters.testify then
		FETCH_DUMMY_SESSION_REPORT = true
	end

	if not session_id then
		FETCH_DUMMY_SESSION_REPORT = true
	end

	if FETCH_DUMMY_SESSION_REPORT then
		return self:_use_dummy_session_report()
	end

	local profile = self:_get_profile()
	local player = Managers.player:player(Network.peer_id(), 1)
	local participant = player:account_id() .. "|" .. profile.character_id
	local session_report_promise = self._backend_interface.gameplay_session:poll_for_end_of_round(session_id, participant)
	local character_xp_settings_promise = self._progression:get_xp_table("character")
	local account_xp_settings_promise = self._progression:get_xp_table("account")

	_info("Fetching session report...")
	Promise.all(session_report_promise, character_xp_settings_promise, account_xp_settings_promise):next(function (results)
		local session_report, character_xp_settings, account_xp_settings = unpack(results)
		local eor = session_report.eor

		_info("Got session report, parsing it...")
		_info("full_session_report: %s", table.tostring(eor, 9))

		self._session_report.character.experience_settings = self:_parse_experience_settings(character_xp_settings)
		self._session_report.account.experience_settings = self:_parse_experience_settings(account_xp_settings)
		self._session_report.character.experience_settings_unparsed = character_xp_settings
		self._session_report.account.experience_settings_unparsed = account_xp_settings

		self:_parse_report(eor)

		return self._backend_interface.wallet:combined_wallets(player:character_id())
	end):next(function (wallets)
		self._session_report.character.wallets = wallets

		self:_parse_wallets(wallets)
	end):catch(function (errors)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-6, warpins: 1 ---
		local error_string = nil

		if type(errors) == "table" then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 7-20, warpins: 1 ---
			local session_report_error, character_xp_error, account_xp_error = unpack(errors)
			error_string = tostring(session_report_error) .. tostring(character_xp_error) .. tostring(account_xp_error)
			--- END OF BLOCK #0 ---



		else

			-- Decompilation error in this vicinity:
			--- BLOCK #0 21-21, warpins: 1 ---
			error_string = errors
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 22-32, warpins: 2 ---
		Log.error("ProgressionManager", "Error fetching session_report: %s", error_string)

		self._session_report_state = SESSION_REPORT_STATES.fail

		return
		--- END OF BLOCK #1 ---



	end)
end

ProgressionManager._parse_experience_settings = function (self, unparsed_xp_settings)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 5-14, warpins: 0 ---
	for i, level_sum_xp in ipairs(unparsed_xp_settings) do

		-- Decompilation error in this vicinity:
		--- BLOCK #0 5-7, warpins: 1 ---
		local previous_level = i - 1
		local previous_level_sum_xp = (previous_level and unparsed_xp_settings[previous_level]) or 0
		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 12-12, warpins: 2 ---
		slot9 = level_sum_xp - previous_level_sum_xp
		--- END OF BLOCK #1 ---

		FLOW; TARGET BLOCK #2



		-- Decompilation error in this vicinity:
		--- BLOCK #2 13-14, warpins: 2 ---
		--- END OF BLOCK #2 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 15-21, warpins: 1 ---
	local max_level = #unparsed_xp_settings
	local experience_settings = {}
	experience_settings.experience_table = unparsed_xp_settings
	experience_settings.max_level_experience = unparsed_xp_settings[max_level]
	experience_settings.max_level = max_level

	return experience_settings
	--- END OF BLOCK #2 ---



end

ProgressionManager._parse_report = function (self, eor)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-19, warpins: 1 ---
	local player = Managers.player:player(Network.peer_id(), 1)
	local my_account_id = player:account_id()
	local account_data = self:_get_account_data(eor, my_account_id)

	if not account_data then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 20-29, warpins: 1 ---
		Log.error("ProgressManager", "No account data found for me in session report, account_id: %s", my_account_id)

		self._session_report_state = SESSION_REPORT_STATES.fail

		return
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 30-35, warpins: 1 ---
	local progression = self:_get_progression(account_data)

	if not progression then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 36-45, warpins: 1 ---
		Log.error("ProgressionManager", "No progression found for me in session report, account_id: %s", my_account_id)

		self._session_report_state = SESSION_REPORT_STATES.fail

		return
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 46-51, warpins: 1 ---
	local inventory = self:_get_inventory(account_data)

	if not inventory then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 52-61, warpins: 1 ---
		Log.error("ProgressionManager", "No inventory found for me in session report, account_id: %s", my_account_id)

		self._session_report_state = SESSION_REPORT_STATES.fail

		return
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 62-71, warpins: 1 ---
	self._session_report.character.inventory = inventory
	local character_stats = self:_get_progression_stats(progression, "character")

	if not character_stats then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 72-81, warpins: 1 ---
		Log.error("ProgressionManager", "No character_stats found for me in session report, account_id: %s", my_account_id)

		self._session_report_state = SESSION_REPORT_STATES.fail

		return
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #3 ---

	FLOW; TARGET BLOCK #4



	-- Decompilation error in this vicinity:
	--- BLOCK #4 82-88, warpins: 1 ---
	local account_stats = self:_get_progression_stats(progression, "account")

	if not account_stats then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 89-98, warpins: 1 ---
		Log.warning("ProgressionManager", "No account_stats found for me in session report, account_id: %s", my_account_id)

		self._session_report_state = SESSION_REPORT_STATES.fail

		return
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #4 ---

	FLOW; TARGET BLOCK #5



	-- Decompilation error in this vicinity:
	--- BLOCK #5 99-159, warpins: 1 ---
	self:_parse_stats(character_stats)
	self:_parse_stats(account_stats)
	self:_parse_mission_stats(eor)
	self:_parse_team_stats(eor)
	self:_parse_reward_cards(account_data)

	local credits_reward = self:_get_credits_reward(account_data.missionRewards)
	self._session_report.credits_reward = credits_reward
	local promise_list = {}
	local character_level_up_promise = self:_check_level_up(character_stats)

	table.insert(promise_list, character_level_up_promise)

	local account_level_up_promise = self:_check_level_up(account_stats)

	table.insert(promise_list, account_level_up_promise)
	Promise.all(unpack(promise_list)):next(function (data)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-3, warpins: 1 ---
		if FETCH_DUMMY_SESSION_REPORT then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 4-11, warpins: 1 ---
			self._session_report_state = SESSION_REPORT_STATES.success

			_info("Dummmy session_report fetched and parsed successfully")

			return
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 12-44, warpins: 1 ---
		local profile = self:_get_profile()
		local character_id = profile.character_id

		Promise.all(Managers.backend.interfaces.gear:fetch(), Managers.backend.interfaces.progression:get_progression("character", character_id), MasterItems.refresh()):next(function (results)

			-- Decompilation error in this vicinity:
			--- BLOCK #0 1-7, warpins: 1 ---
			local gear_list, character_progression, result = unpack(results)
			profile.current_level = character_progression.currentLevel or 1
			self._session_report_state = SESSION_REPORT_STATES.success

			_info("session_report fetched and parsed successfully")
			_info("session_report: %s", table.tostring(self._session_report, 9))

			return
			--- END OF BLOCK #0 ---

			FLOW; TARGET BLOCK #1



			-- Decompilation error in this vicinity:
			--- BLOCK #1 9-26, warpins: 2 ---
			--- END OF BLOCK #1 ---



		end)

		return
		--- END OF BLOCK #1 ---

		FLOW; TARGET BLOCK #2



		-- Decompilation error in this vicinity:
		--- BLOCK #2 45-45, warpins: 2 ---
		--- END OF BLOCK #2 ---



	end):catch(function (errors)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-6, warpins: 1 ---
		local error_string = nil

		if type(errors) == "table" then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 7-13, warpins: 1 ---
			error_string = table.tostring(errors, 5)
			--- END OF BLOCK #0 ---



		else

			-- Decompilation error in this vicinity:
			--- BLOCK #0 14-14, warpins: 1 ---
			error_string = errors
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 15-25, warpins: 2 ---
		Log.error("ProgressionManager", "Error parsing session_report: %s", error_string)

		self._session_report_state = SESSION_REPORT_STATES.fail

		return
		--- END OF BLOCK #1 ---



	end)

	return
	--- END OF BLOCK #5 ---

	FLOW; TARGET BLOCK #6



	-- Decompilation error in this vicinity:
	--- BLOCK #6 160-160, warpins: 2 ---
	--- END OF BLOCK #6 ---

	FLOW; TARGET BLOCK #7



	-- Decompilation error in this vicinity:
	--- BLOCK #7 161-161, warpins: 2 ---
	--- END OF BLOCK #7 ---

	FLOW; TARGET BLOCK #8



	-- Decompilation error in this vicinity:
	--- BLOCK #8 162-162, warpins: 2 ---
	--- END OF BLOCK #8 ---

	FLOW; TARGET BLOCK #9



	-- Decompilation error in this vicinity:
	--- BLOCK #9 163-163, warpins: 2 ---
	--- END OF BLOCK #9 ---

	FLOW; TARGET BLOCK #10



	-- Decompilation error in this vicinity:
	--- BLOCK #10 164-164, warpins: 2 ---
	--- END OF BLOCK #10 ---



end

ProgressionManager._parse_wallets = function (self, wallets)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-8, warpins: 1 ---
	local session_report_rewards = self._session_report.character.rewards
	local salary_card = nil

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 9-15, warpins: 0 ---
	for i = 1, #session_report_rewards, 1 do

		-- Decompilation error in this vicinity:
		--- BLOCK #0 9-12, warpins: 2 ---
		local reward_card = session_report_rewards[i]

		if reward_card.kind == "salary" then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 13-14, warpins: 1 ---
			salary_card = reward_card

			--- END OF BLOCK #0 ---

			FLOW; TARGET BLOCK #1



			-- Decompilation error in this vicinity:
			--- BLOCK #1 15-15, warpins: 1 ---
			break
			--- END OF BLOCK #1 ---



		end
		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 15-15, warpins: 1 ---
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 16-17, warpins: 2 ---
	local salary_rewards = salary_card and salary_card.rewards

	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 19-20, warpins: 2 ---
	if salary_rewards then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 21-24, warpins: 1 ---
		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 25-36, warpins: 0 ---
		for i = 1, #salary_rewards, 1 do

			-- Decompilation error in this vicinity:
			--- BLOCK #0 25-32, warpins: 2 ---
			local salary_reward = salary_rewards[i]
			local currency = salary_reward.currency
			local wallet = wallets:by_type(currency)

			if wallet then

				-- Decompilation error in this vicinity:
				--- BLOCK #0 33-35, warpins: 1 ---
				salary_reward.current_amount = wallet.balance.amount
				--- END OF BLOCK #0 ---



			end
			--- END OF BLOCK #0 ---

			FLOW; TARGET BLOCK #1



			-- Decompilation error in this vicinity:
			--- BLOCK #1 36-36, warpins: 2 ---
			--- END OF BLOCK #1 ---



		end
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #3 ---

	FLOW; TARGET BLOCK #4



	-- Decompilation error in this vicinity:
	--- BLOCK #4 37-37, warpins: 2 ---
	return
	--- END OF BLOCK #4 ---



end

ProgressionManager._get_account_data = function (self, eor, my_account_id)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-6, warpins: 1 ---
	local team = eor.team
	local participants = team.participants

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 7-12, warpins: 0 ---
	for _, participant in ipairs(participants) do

		-- Decompilation error in this vicinity:
		--- BLOCK #0 7-9, warpins: 1 ---
		local participant_account_id = participant.accountId

		if participant_account_id == my_account_id then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 10-10, warpins: 1 ---
			return participant
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 11-12, warpins: 3 ---
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 13-13, warpins: 1 ---
	return
	--- END OF BLOCK #2 ---



end

ProgressionManager._get_progression = function (self, account_data)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-2, warpins: 1 ---
	return account_data.progression
	--- END OF BLOCK #0 ---



end

ProgressionManager._get_inventory = function (self, account_data)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	local character_details = account_data.characterDetails

	return character_details and character_details.inventory
	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 5-5, warpins: 2 ---
	--- END OF BLOCK #1 ---



end

ProgressionManager._get_credits_reward = function (self, reward_cards)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-2, warpins: 1 ---
	if not reward_cards then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 3-4, warpins: 1 ---
		return 0
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 5-9, warpins: 2 ---
	local len = #reward_cards

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 10-32, warpins: 0 ---
	for i = 1, len, 1 do

		-- Decompilation error in this vicinity:
		--- BLOCK #0 10-13, warpins: 2 ---
		local card = reward_cards[i]

		if card.kind == "salary" then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 14-19, warpins: 1 ---
			local rewards = card.rewards
			local reward_len = #rewards

			--- END OF BLOCK #0 ---

			FLOW; TARGET BLOCK #1



			-- Decompilation error in this vicinity:
			--- BLOCK #1 20-30, warpins: 0 ---
			for j = 1, reward_len, 1 do

				-- Decompilation error in this vicinity:
				--- BLOCK #0 20-23, warpins: 2 ---
				local reward = rewards[j]

				if reward.rewardType == "currency" and reward.currency == "credits" then

					-- Decompilation error in this vicinity:
					--- BLOCK #0 27-28, warpins: 1 ---
					return reward.amount
					--- END OF BLOCK #0 ---



				end

				--- END OF BLOCK #0 ---

				FLOW; TARGET BLOCK #1



				-- Decompilation error in this vicinity:
				--- BLOCK #1 29-30, warpins: 3 ---
				j = j + 1
				--- END OF BLOCK #1 ---



			end
			--- END OF BLOCK #1 ---



		end

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 31-32, warpins: 2 ---
		i = i + 1
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 33-34, warpins: 1 ---
	return 0
	--- END OF BLOCK #3 ---



end

ProgressionManager._parse_stats = function (self, stats)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-10, warpins: 1 ---
	local start_xp = stats.startXp
	local current_xp = stats.currentXp
	local experience_gained = current_xp - start_xp
	local report_sheet = self._session_report[stats.type]
	report_sheet.starting_experience = start_xp
	report_sheet.current_experience = current_xp
	report_sheet.experience_gained = experience_gained

	return
	--- END OF BLOCK #0 ---



end

ProgressionManager._get_profile = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-8, warpins: 1 ---
	local profile = Managers.player:local_player_backend_profile()

	if FETCH_DUMMY_SESSION_REPORT and not profile then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 11-23, warpins: 1 ---
		local player = Managers.player:player(Network.peer_id(), 1)
		profile = player:profile()
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 24-24, warpins: 3 ---
	return profile
	--- END OF BLOCK #1 ---



end

ProgressionManager._get_progression_stats = function (self, progression, stat_type)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 5-10, warpins: 0 ---
	for _, stats in ipairs(progression) do

		-- Decompilation error in this vicinity:
		--- BLOCK #0 5-7, warpins: 1 ---
		if stats.type == stat_type then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 8-8, warpins: 1 ---
			return stats
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 9-10, warpins: 3 ---
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 11-11, warpins: 1 ---
	return
	--- END OF BLOCK #2 ---



end

ProgressionManager._parse_team_stats = function (self, eor)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-9, warpins: 1 ---
	local team = eor.team
	local session_statistics = team.sessionStatistics
	local total_kills = self:_get_session_stat(session_statistics, "stat/minion_kills") or 0
	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 11-17, warpins: 2 ---
	local total_deaths = self:_get_session_stat(session_statistics, "stat/player_deaths") or 0
	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 19-25, warpins: 2 ---
	self._session_report.team.total_kills = total_kills
	self._session_report.team.total_deaths = total_deaths

	return
	--- END OF BLOCK #2 ---



end

ProgressionManager._get_session_stat = function (self, session_statistics, stat_type)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 5-11, warpins: 0 ---
	for i, stat in ipairs(session_statistics) do

		-- Decompilation error in this vicinity:
		--- BLOCK #0 5-7, warpins: 1 ---
		local type_path = stat.typePath

		if type_path == stat_type then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 8-9, warpins: 1 ---
			local value = stat.sessionValue

			return value
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 10-11, warpins: 3 ---
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 12-12, warpins: 1 ---
	return
	--- END OF BLOCK #2 ---



end

ProgressionManager._parse_mission_stats = function (self, eor)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-6, warpins: 1 ---
	local mission = eor.mission
	local play_time_seconds = mission.playTimeSeconds
	self._session_report.team.play_time_seconds = play_time_seconds

	return
	--- END OF BLOCK #0 ---



end

ProgressionManager._parse_reward_cards = function (self, account_data)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	local reward_cards = account_data.rewardCards

	if not reward_cards then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 4-4, warpins: 1 ---
		return
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 5-19, warpins: 2 ---
	local character_rewards = self._session_report.character.rewards

	assert(character_rewards)
	table.create_copy(character_rewards, reward_cards)

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 20-66, warpins: 0 ---
	for i = 1, #character_rewards, 1 do

		-- Decompilation error in this vicinity:
		--- BLOCK #0 20-25, warpins: 2 ---
		local reward_card = character_rewards[i]
		local reward_card_rewards = reward_card.rewards

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 26-65, warpins: 0 ---
		for j = 1, #reward_card_rewards, 1 do

			-- Decompilation error in this vicinity:
			--- BLOCK #0 26-29, warpins: 2 ---
			local reward = reward_card_rewards[j]
			reward.amount_gained = reward.amount or 0
			reward.amount = nil
			reward.reward_type = reward.rewardType
			reward.rewardType = nil
			reward.master_id = reward.masterId
			reward.masterId = nil
			reward.gear_id = reward.gearId
			reward.gearId = nil
			local details = reward.details

			--- END OF BLOCK #0 ---

			FLOW; TARGET BLOCK #1



			-- Decompilation error in this vicinity:
			--- BLOCK #1 31-48, warpins: 2 ---
			if details then

				-- Decompilation error in this vicinity:
				--- BLOCK #0 49-64, warpins: 1 ---
				details.from_circumstance = details.fromCircumstance
				details.fromCircumstance = nil
				details.from_side_mission = details.fromSideMission
				details.fromSideMission = nil
				details.from_side_mission_bonus = details.fromSideMissionBonus
				details.fromSideMissionBonus = nil
				details.from_total_bonus = details.fromTotalBonus
				details.fromTotalBonus = nil
				--- END OF BLOCK #0 ---



			end
			--- END OF BLOCK #1 ---

			FLOW; TARGET BLOCK #2



			-- Decompilation error in this vicinity:
			--- BLOCK #2 65-65, warpins: 2 ---
			--- END OF BLOCK #2 ---



		end
		--- END OF BLOCK #1 ---

		FLOW; TARGET BLOCK #2



		-- Decompilation error in this vicinity:
		--- BLOCK #2 66-66, warpins: 1 ---
		--- END OF BLOCK #2 ---



	end

	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 67-67, warpins: 1 ---
	return
	--- END OF BLOCK #3 ---



end

ProgressionManager.session_report = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-6, warpins: 1 ---
	assert(self._session_report_state == SESSION_REPORT_STATES.success, "trying to use session_report before its successfully fetched from the backend")
	_info("Parsed session report has been returned")

	return self._session_report
	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 10-16, warpins: 2 ---
	--- END OF BLOCK #1 ---



end

ProgressionManager._check_level_up = function (self, stats)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	if FETCH_DUMMY_SESSION_REPORT then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 4-9, warpins: 1 ---
		_info("Dummy Session report level up completed")

		return Promise.resolved()
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 10-12, warpins: 2 ---
	local needed_xp_for_next_level = stats.neededXpForNextLevel

	if needed_xp_for_next_level == 0 then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 13-19, warpins: 1 ---
		local current_level = stats.currentLevel
		local next_level = current_level + 1

		return self:_level_up(stats, next_level)
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 20-21, warpins: 2 ---
	if needed_xp_for_next_level == -1 then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 22-25, warpins: 1 ---
		self:_cap_xp(stats)
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 26-35, warpins: 2 ---
	_info("Session report " .. stats.type .. " level up completed [id:%s]", stats.id)

	return Promise.resolved()
	--- END OF BLOCK #3 ---



end

ProgressionManager._level_up = function (self, stats, target_level)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-23, warpins: 1 ---
	_info("Leveling up " .. stats.type .. " to %s ...", target_level)

	return self._progression:level_up(stats.type, stats.id, target_level):next(function (data)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-23, warpins: 1 ---
		_info("level_up %s: %s", stats.type, table.tostring(data, 6))
		self:_parse_rewards(stats.type, data)

		local progression_info = data.progressionInfo

		return self:_check_level_up(progression_info)
		--- END OF BLOCK #0 ---



	end):catch(function (error)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-12, warpins: 1 ---
		self._session_report_state = SESSION_REPORT_STATES.fail

		_info("Failed level_up, error: %s", error)

		return Promise.rejected(error)
		--- END OF BLOCK #0 ---



	end)
	--- END OF BLOCK #0 ---



end

ProgressionManager._parse_rewards = function (self, type, data)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-10, warpins: 1 ---
	local rewards = self._session_report[type].rewards
	local reward_info = data.rewardInfo
	local reward_list = reward_info.rewards
	local display_duration = 0.8

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 11-44, warpins: 0 ---
	for i, reward in ipairs(reward_list) do

		-- Decompilation error in this vicinity:
		--- BLOCK #0 11-13, warpins: 1 ---
		local reward_type = reward.rewardType

		if reward_type == "item" then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 14-20, warpins: 1 ---
			local reward_item_id = reward.masterId

			if MasterItems.item_exists(reward_item_id) then

				-- Decompilation error in this vicinity:
				--- BLOCK #0 21-36, warpins: 1 ---
				local reward_data = {
					text = "testing testing"
				}
				reward_data.type = reward_type
				reward_data.reward_item_id = reward_item_id
				reward_data.duration = display_duration
				reward_data.level = reward_info.level

				table.insert(rewards, reward_data)
				ItemUtils.mark_item_id_as_new(reward.gearId)
				--- END OF BLOCK #0 ---



			else

				-- Decompilation error in this vicinity:
				--- BLOCK #0 37-42, warpins: 1 ---
				Log.error("ProgressionManager", "Recieved invalid item %s as reward from backend", reward_item_id)
				--- END OF BLOCK #0 ---



			end
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 43-44, warpins: 4 ---
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 45-51, warpins: 1 ---
	local level_up_to_level = reward_info.level

	self:_add_level_up_reward_to_card(reward_list, level_up_to_level)

	return
	--- END OF BLOCK #2 ---



end

ProgressionManager._add_level_up_reward_to_card = function (self, reward_list, level_up_to_level)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	local reward_cards = self._session_report.reward_cards

	if not reward_cards then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 5-5, warpins: 1 ---
		return
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 6-9, warpins: 2 ---
	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 10-23, warpins: 0 ---
	for i, card in ipairs(reward_cards) do

		-- Decompilation error in this vicinity:
		--- BLOCK #0 10-10, warpins: 2 ---
		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 10-21, warpins: 0 ---
		repeat

			-- Decompilation error in this vicinity:
			--- BLOCK #0 10-10, warpins: 2 ---
			--- END OF BLOCK #0 ---

			FLOW; TARGET BLOCK #1



			-- Decompilation error in this vicinity:
			--- BLOCK #1 11-13, warpins: 1 ---
			local kind = card.kind

			if kind ~= "levelUp" then

				-- Decompilation error in this vicinity:
				--- BLOCK #0 14-14, warpins: 1 ---
				break
				--- END OF BLOCK #0 ---



			end

			--- END OF BLOCK #1 ---

			FLOW; TARGET BLOCK #2



			-- Decompilation error in this vicinity:
			--- BLOCK #2 15-17, warpins: 1 ---
			local level = card.level

			if level ~= level_up_to_level then

				-- Decompilation error in this vicinity:
				--- BLOCK #0 18-18, warpins: 1 ---
				break
				--- END OF BLOCK #0 ---



			end

			--- END OF BLOCK #2 ---

			FLOW; TARGET BLOCK #3



			-- Decompilation error in this vicinity:
			--- BLOCK #3 19-21, warpins: 1 ---
			card.rewards = reward_list
			--- END OF BLOCK #3 ---



		until true
		--- END OF BLOCK #1 ---

		FLOW; TARGET BLOCK #2



		-- Decompilation error in this vicinity:
		--- BLOCK #2 22-23, warpins: 4 ---
		--- END OF BLOCK #2 ---



	end

	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 24-24, warpins: 1 ---
	return
	--- END OF BLOCK #3 ---



end

ProgressionManager._cap_xp = function (self, stats)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-30, warpins: 1 ---
	local report_sheet = self._session_report[stats.type]
	local experience_settings = report_sheet.experience_settings_unparsed
	local level = stats.currentLevel
	local max_experience = experience_settings[level]
	local session_starting_experience = report_sheet.starting_experience
	local starting_experience = math.min(session_starting_experience, max_experience)
	local current_experience = math.min(stats.currentXp, max_experience)
	local experience_gained = current_experience - starting_experience
	report_sheet.starting_experience = starting_experience
	report_sheet.current_experience = current_experience
	report_sheet.experience_gained = experience_gained
	report_sheet.max_level_reached = true

	_info("%s is capped at level: %s, xp: %s ", stats.type, level, max_experience)

	return
	--- END OF BLOCK #0 ---



end

ProgressionManager.get_item_rank = function (self, item)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	return item.weapon_level or 1
	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 5-5, warpins: 2 ---
	--- END OF BLOCK #1 ---



end

ProgressionManager.get_traits = function (self, item)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	if not item.bound_traits then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 4-4, warpins: 1 ---
		return
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 5-9, warpins: 2 ---
	local bound_traits = table.clone(item.bound_traits)

	return bound_traits
	--- END OF BLOCK #1 ---



end

ProgressionManager.is_trait_slot_unlocked = function (self, item, slot_index)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	local bound_traits = item.bound_traits

	if not bound_traits then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 4-6, warpins: 1 ---
		return false, 1
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 7-10, warpins: 2 ---
	local trait_unlocked_at = slot_index
	local weapon_level = item.weapon_level or math.huge
	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 13-14, warpins: 2 ---
	local trait_slot_unlocked = trait_unlocked_at <= weapon_level

	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 18-20, warpins: 2 ---
	return trait_slot_unlocked, trait_unlocked_at
	--- END OF BLOCK #3 ---



end

ProgressionManager._use_dummy_session_report = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-9, warpins: 1 ---
	self._dummy_session_promise = Promise.new()

	if FETCH_DUMMY_SESSION_REPORT_DELAY.max > 0 then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 10-29, warpins: 1 ---
		local t = Managers.time:time("main")
		local delay = math.random_range(FETCH_DUMMY_SESSION_REPORT_DELAY.min, FETCH_DUMMY_SESSION_REPORT_DELAY.max)

		_info("Fetching dummy session report with delay %s sec", delay)

		self._fetch_session_report_at = t + delay
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 30-32, warpins: 1 ---
		self:_fetch_dummy_session_report()
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 33-34, warpins: 2 ---
	return self._dummy_session_promise
	--- END OF BLOCK #1 ---



end

ProgressionManager._fetch_dummy_session_report = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-11, warpins: 1 ---
	local player = Managers.player:player(Network.peer_id(), 1)
	local my_account_id = player and player:account_id()
	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 15-81, warpins: 2 ---
	local session_report = DummySessionReport.fetch_session_report(my_account_id)
	local character_xp = DummySessionReport.fetch_xp_table("character")
	local account_xp = DummySessionReport.fetch_xp_table("account")
	local inventory = DummySessionReport.fetch_inventory(session_report)
	self._session_report.character.inventory = inventory
	self._session_report.character.experience_settings = self:_parse_experience_settings(character_xp)
	self._session_report.account.experience_settings = self:_parse_experience_settings(account_xp)

	self:_parse_report(session_report)

	self._session_report_state = SESSION_REPORT_STATES.success
	local dummy_wallet = {}
	dummy_wallet.wallets = {
		{
			balance = {
				amount = 12345,
				type = "credits"
			}
		},
		{
			balance = {
				amount = 2345,
				type = "plasteel"
			}
		},
		{
			balance = {
				amount = 25,
				type = "diamantine"
			}
		}
	}

	dummy_wallet.by_type = function (self, wallet_type)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-2, warpins: 1 ---
		if wallet_type == "credits" then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 3-6, warpins: 1 ---
			return self.wallets[1]
			--- END OF BLOCK #0 ---



		else

			-- Decompilation error in this vicinity:
			--- BLOCK #0 7-8, warpins: 1 ---
			if wallet_type == "plasteel" then

				-- Decompilation error in this vicinity:
				--- BLOCK #0 9-12, warpins: 1 ---
				return self.wallets[2]
				--- END OF BLOCK #0 ---



			else

				-- Decompilation error in this vicinity:
				--- BLOCK #0 13-14, warpins: 1 ---
				if wallet_type == "diamantine" then

					-- Decompilation error in this vicinity:
					--- BLOCK #0 15-17, warpins: 1 ---
					return self.wallets[3]
					--- END OF BLOCK #0 ---



				end
				--- END OF BLOCK #0 ---



			end
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 18-18, warpins: 4 ---
		return
		--- END OF BLOCK #1 ---



	end

	self._session_report.character.wallets = dummy_wallet

	self:_parse_wallets(dummy_wallet)

	if self._dummy_session_promise then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 82-85, warpins: 1 ---
		self._dummy_session_promise:resolve()
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 86-86, warpins: 2 ---
	return
	--- END OF BLOCK #2 ---



end

ProgressionManager.fetch_dummy_session_report = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-27, warpins: 1 ---
	self._session_report = {}
	self._session_report.team = {}
	self._session_report.character = {}
	self._session_report.character.rewards = {}
	self._session_report.account = {}
	self._session_report.account.rewards = {}
	self._session_report.weapon = {}

	self:_fetch_dummy_session_report()

	return self._session_report
	--- END OF BLOCK #0 ---



end

ProgressionManager.update = function (self, dt, t)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-3, warpins: 1 ---
	local fetch_session_report_at = self._fetch_session_report_at

	if fetch_session_report_at and fetch_session_report_at <= t then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 6-13, warpins: 1 ---
		self:_fetch_dummy_session_report()
		_info("Fetch dummy session report completed")

		self._fetch_session_report_at = nil
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 14-14, warpins: 3 ---
	return
	--- END OF BLOCK #1 ---



end

return ProgressionManager
