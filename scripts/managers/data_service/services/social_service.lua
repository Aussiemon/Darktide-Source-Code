-- Decompilation Error: _glue_flows(node)

-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
-- WARNING: Error occurred during decompilation.
--   Code may be incomplete or incorrect.
local PartyConstants = require("scripts/settings/network/party_constants")
local PlayerCompositions = require("scripts/utilities/players/player_compositions")
local PlayerInfo = require("scripts/managers/data_service/services/social/player_info")
local Promise = require("scripts/foundation/utilities/promise")
local SocialConstants = require("scripts/managers/data_service/services/social/social_constants")
local PartyState = PartyConstants.State
local Platforms = SocialConstants.Platforms
local OnlineStatus = SocialConstants.OnlineStatus
local PartyStatus = SocialConstants.PartyStatus
local FriendStatus = SocialConstants.FriendStatus
local HOST_TYPE_HUB_SERVER = "hub_server"
local HOST_TYPE_MISSION_SERVER = "mission_server"
local SocialService = class("SocialService")

local function _warning(...)
	Log.warning("SocialService", ...)
end

SocialService.init = function (self, backend_interfaces)
	if LEVEL_EDITOR_TEST then
		local SocialDummy = require("scripts/managers/data_service/services/social/social_dummy")
		self._platform_social = SocialDummy:new()
		local InvitesDummy = require("scripts/managers/data_service/services/invites/invites_dummy")
		self._invites = InvitesDummy:new()
	else
		local platform = Managers.presence:presence_entry_myself():platform()
		self._platform = platform

		if platform == Platforms.steam then
			local SocialSteam = require("scripts/managers/data_service/services/social/social_steam")
			self._platform_social = SocialSteam:new()
			local InvitesSteam = require("scripts/managers/data_service/services/invites/invites_steam")
			self._invites = InvitesSteam:new()
		elseif platform == Platforms.xbox then
			local SocialXboxLive = require("scripts/managers/data_service/services/social/social_xbox_live")
			self._platform_social = SocialXboxLive:new()
			local InvitesXboxLive = require("scripts/managers/data_service/services/invites/invites_xbox_live")
			self._invites = InvitesXboxLive:new()
		else
			local SocialDummy = require("scripts/managers/data_service/services/social/social_dummy")
			self._platform_social = SocialDummy:new()
			local InvitesDummy = require("scripts/managers/data_service/services/invites/invites_dummy")
			self._invites = InvitesDummy:new()
		end
	end

	self._backend_interfaces = backend_interfaces.social
	self._friends_list = {}
	self._friends_list_promise = Promise.resolved()
	self._fatshark_friends_promise = Promise.resolved()
	self._friends_list_has_changed = true
	self._num_fatshark_friends = 0
	self._max_fatshark_friends = 0
	self._friend_invites_promise = Promise.resolved()
	self._recent_companions_promise = Promise.resolved()
	self._recent_companions_character_id = nil
	self._players_by_account_id = {}
	self._players_by_platform_user_id = {}
	self._party_members = {}
	self._num_party_members = 0
	self._blocked_accounts_list = {}
	self._blocked_accounts_list_promise = Promise.resolved()
	self._blocked_accounts_list_changed = true
	self._num_blocked_accounts = 0
	self._max_blocked_accounts = 0
	self._blocked_players_list = {}
	self._cb_presence_account_id_change = callback(self, "cb_presence_account_id_change")
end

SocialService.destroy = function (self)
	self._platform_social:delete()

	self._platform_social = nil

	self._invites:delete()

	self._invites = nil
	self._backend_interfaces = nil
end

SocialService.update = function (self, dt, t)
	if self._voting_id and not Managers.voting:voting_exists(self._voting_id) then
		self._voting_id = nil
	end

	self._invites:update()
end

SocialService.platform = function (self)
	return self._platform
end

SocialService.platform_display_name = function (self)
	local platform = self._platform

	if platform == Platforms.steam then
		return "Steam"
	elseif platform == Platforms.xbox then
		return "Xbox Live"
	end

	return ""
end

SocialService.is_in_hub = function (self)
	local host_type = Managers.connection:host_type()

	return host_type == HOST_TYPE_HUB_SERVER
end

SocialService.is_in_mission = function (self)
	local host_type = Managers.connection:host_type()

	return host_type == HOST_TYPE_MISSION_SERVER
end

SocialService.is_in_matchmaking = function (self)
	local immaterium_party_manager = Managers.party_immaterium
	local matchmaking_state = immaterium_party_manager:current_state()
	local is_in_matchmaking = matchmaking_state == PartyState.matchmaking or matchmaking_state == PartyState.matchmaking_acceptance_vote

	return is_in_matchmaking
end

local _temp_team_members = {}

SocialService.fetch_party_members = function (self)
	local promise = Promise:new()
	local temp_team_members = PlayerCompositions.players("party", _temp_team_members)

	if self:is_in_mission() then
		local dont_clear_table = true
		temp_team_members = PlayerCompositions.players("players", _temp_team_members, dont_clear_table)

		for unique_id_1, player_1 in pairs(temp_team_members) do
			for unique_id_2, player_2 in pairs(temp_team_members) do
				if unique_id_2 ~= unique_id_1 then
					local player_1_profile = player_1:profile()
					local player_2_profile = player_2:profile()
					local player_1_character_id = player_1_profile and player_1_profile.character_id
					local player_2_character_id = player_2_profile and player_2_profile.character_id

					if player_1_character_id == player_2_character_id then
						temp_team_members[unique_id_2] = nil
					end
				end
			end
		end

		for unique_id, player in pairs(temp_team_members) do
			if not player:is_human_controlled() then
				temp_team_members[unique_id] = nil
			end
		end
	end

	local party_members = self._party_members

	for current_member_unique_id, current_party_member in pairs(party_members) do
		if not temp_team_members[current_member_unique_id] then
			local player_info = party_members[current_member_unique_id]

			player_info:set_is_party_member(false)

			party_members[current_member_unique_id] = nil
		end
	end

	local num_party_members = 0

	for unique_id, player in pairs(temp_team_members) do
		if not party_members[unique_id] then
			local player_info = self:_get_player_info_for_player(player)

			player_info:set_is_party_member(true)

			party_members[unique_id] = player_info
		end

		num_party_members = num_party_members + 1
	end

	self._num_party_members = num_party_members

	promise:resolve(self._party_members)

	return promise
end

SocialService.fetch_friends = function (self, force_update)
	local platform_friends_manager = self._platform_social
	local friends_list_has_changed = self._friends_list_has_changed or platform_friends_manager:friends_list_has_changes()
	local friends_list_promise = self._friends_list_promise

	if (not friends_list_has_changed and not force_update) or friends_list_promise:is_pending() then
		return friends_list_promise
	end

	local platform_friends_promise = self:_fetch_platform_friends()
	local fatshark_friends_promise = self:_fetch_fatshark_friends()
	local num_promises = 2

	local function aggregate_function(friends_data)
		local friends = {}
		self._friends_list_has_changed = false

		for friends_data_index = 1, num_promises, 1 do
			local friends_data_list = friends_data[friends_data_index]

			if friends_data_list then
				for friends_list_index = 1, #friends_data_list, 1 do
					local friend = friends_data_list[friends_list_index]

					if friend:is_friend() then
						local is_duplicate = false

						if friends_data_index > 1 then
							for i = 1, #friends, 1 do
								is_duplicate = is_duplicate or friends[i] == friend
							end
						end

						if not is_duplicate then
							friends[#friends + 1] = friend
						end
					end
				end
			else
				self._friends_list_has_changed = true
			end
		end

		self._friends_list = friends

		return friends
	end

	friends_list_promise = Promise.all(platform_friends_promise, fatshark_friends_promise):next(aggregate_function, aggregate_function)
	self._friends_list_promise = friends_list_promise

	return friends_list_promise
end

local _fetch_friend_invites_friend_invites = {}

SocialService.fetch_friend_invites = function (self)
	local friend_invites_promise = self._friend_invites_promise

	if friend_invites_promise:is_pending() then
		return friend_invites_promise
	end

	return self:_fetch_fatshark_friends():next(function (friends_data)
		local friend_invites = _fetch_friend_invites_friend_invites

		if not friends_data then
			return friend_invites
		end

		table.clear_array(friend_invites, #friend_invites)

		local is_invite = FriendStatus.invite
		local is_invited = FriendStatus.invited

		for i = 1, #friends_data, 1 do
			local friend = friends_data[i]
			local friend_status = friend:friend_status()

			if friend_status == is_invite or friend_status == is_invited then
				friend_invites[#friend_invites + 1] = friend
			end
		end

		return friend_invites
	end)
end

local _recent_companions = {}

SocialService.fetch_recent_companions = function (self, character_id, force_refresh)
	local recent_companions_promise = self._recent_companions_promise

	if self._recent_companions_character_id == character_id and (not force_refresh or recent_companions_promise:is_pending()) then
		return recent_companions_promise
	end

	recent_companions_promise = self._backend_interfaces:fetch_recently_played(character_id):next(function (data)
		local recent_companions = _recent_companions

		table.clear_array(recent_companions, #recent_companions)

		local recent_participants = data.recentParticipants

		for i = 1, #recent_participants, 1 do
			local recent_companion = recent_participants[i]
			local account_id = recent_companion.accountId
			local account_name = recent_companion.accountName
			local player_info = self:_get_player_info_by_account_id(account_id)

			player_info:set_account(account_id, account_name)

			local last_time_played_with = math.floor(tonumber(recent_companion.playedAt) / 1000)

			player_info:set_last_time_played_with(last_time_played_with)

			if not player_info:is_blocked() then
				recent_companions[#recent_companions + 1] = player_info
			end
		end

		return recent_companions
	end):catch(function (error)
		_warning(string.format("Failed fetching recently played with accounts: %s", error))

		return {}
	end)
	self._recent_companions_promise = recent_companions_promise
	self._recent_companions_character_id = character_id

	return recent_companions_promise
end

local _fetch_players_on_server_players_on_server = {}
local _fetch_players_on_server_composition_players = {}

SocialService.fetch_players_on_server = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-15, warpins: 1 ---
	local players_on_server = _fetch_players_on_server_players_on_server
	local composition_players = _fetch_players_on_server_composition_players

	table.clear(players_on_server)

	local promise = Promise:new()
	local is_in_hub = self:is_in_hub()

	if is_in_hub then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 16-29, warpins: 1 ---
		PlayerCompositions.players("players", composition_players)

		local players = Managers.player:human_players()

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 30-48, warpins: 0 ---
		for unique_id, player in pairs(players) do

			-- Decompilation error in this vicinity:
			--- BLOCK #0 30-34, warpins: 1 ---
			if player:is_human_controlled() then

				-- Decompilation error in this vicinity:
				--- BLOCK #0 35-43, warpins: 1 ---
				local player_info = self:_get_player_info_for_player(player)

				if not player_info:is_blocked() then

					-- Decompilation error in this vicinity:
					--- BLOCK #0 44-46, warpins: 1 ---
					players_on_server[#players_on_server + 1] = player_info
					--- END OF BLOCK #0 ---



				end
				--- END OF BLOCK #0 ---



			end
			--- END OF BLOCK #0 ---

			FLOW; TARGET BLOCK #1



			-- Decompilation error in this vicinity:
			--- BLOCK #1 47-48, warpins: 4 ---
			--- END OF BLOCK #1 ---



		end

		--- END OF BLOCK #1 ---

		FLOW; TARGET BLOCK #2



		-- Decompilation error in this vicinity:
		--- BLOCK #2 49-53, warpins: 1 ---
		promise:resolve(players_on_server)
		--- END OF BLOCK #2 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 54-57, warpins: 1 ---
		promise:reject(players_on_server)
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 58-58, warpins: 2 ---
	return promise
	--- END OF BLOCK #1 ---



end

SocialService.fetch_blocked_accounts = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	local blocked_accounts_promise = self._blocked_accounts_list_promise

	if self._blocked_accounts_list_changed and not blocked_accounts_promise:is_pending() then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 10-19, warpins: 1 ---
		blocked_accounts_promise = self._backend_interfaces:fetch_blocked_accounts():next(function (data)

			-- Decompilation error in this vicinity:
			--- BLOCK #0 1-13, warpins: 1 ---
			self._max_blocked_accounts = data.maxBlocks
			local blocked_accounts = data.blockList

			self:_update_blocked_players(blocked_accounts)

			self._blocked_accounts_list_changed = false

			return blocked_accounts
			--- END OF BLOCK #0 ---



		end)
		self._blocked_accounts_list_promise = blocked_accounts_promise
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 20-24, warpins: 3 ---
	return blocked_accounts_promise:catch(function (error)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-8, warpins: 1 ---
		_warning(string.format("Failed fetching blocked accounts: %s", error))

		return
		--- END OF BLOCK #0 ---



	end)
	--- END OF BLOCK #1 ---



end

SocialService.fetch_blocked_players = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-12, warpins: 1 ---
	return self:fetch_blocked_accounts():next(function (data)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-3, warpins: 1 ---
		return self._blocked_players_list
		--- END OF BLOCK #0 ---



	end):catch(function (error)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-8, warpins: 1 ---
		_warning(string.format("Failed fetching blocked accounts: %s", error))

		return
		--- END OF BLOCK #0 ---



	end)
	--- END OF BLOCK #0 ---



end

SocialService.has_invite = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	return self._invites:has_invite()
	--- END OF BLOCK #0 ---



end

SocialService.get_invite = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	return self._invites:get_invite()
	--- END OF BLOCK #0 ---



end

SocialService.can_join_party = function (self, player_info)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-7, warpins: 1 ---
	if player_info:online_status() ~= OnlineStatus.online then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 8-10, warpins: 1 ---
		return false, nil
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 11-15, warpins: 2 ---
	local player_party_id = player_info:party_id()

	if not player_party_id then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 16-18, warpins: 1 ---
		return false, nil
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 19-25, warpins: 2 ---
	local player_party_status = player_info:party_status()

	if player_party_status == PartyStatus.mine then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 26-30, warpins: 1 ---
		local reason = "loc_social_party_join_rejection_reason_same_party"

		return false, reason
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 31-34, warpins: 1 ---
		if player_party_status == PartyStatus.invite_pending then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 35-38, warpins: 1 ---
			local reason = "loc_social_party_join_rejection_reason_invite_pending"

			return false, reason
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 39-43, warpins: 3 ---
	if player_info:player_activity_id() == "mission" then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 44-50, warpins: 1 ---
		local player_num_party_members = player_info:num_mission_members()

		if player_num_party_members == SocialConstants.max_num_party_members then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 51-55, warpins: 1 ---
			local reason = "loc_social_party_join_rejection_reason_party_full"

			return false, reason
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 56-62, warpins: 1 ---
		local player_num_party_members = player_info:num_party_members()

		if player_num_party_members == SocialConstants.max_num_party_members then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 63-66, warpins: 1 ---
			local reason = "loc_social_party_join_rejection_reason_party_full"

			return false, reason
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #3 ---

	FLOW; TARGET BLOCK #4



	-- Decompilation error in this vicinity:
	--- BLOCK #4 67-71, warpins: 4 ---
	if self:is_in_matchmaking() then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 72-75, warpins: 1 ---
		local reason = "loc_social_party_join_rejection_reason_you_are_in_matchmaking"

		return false, reason
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #4 ---

	FLOW; TARGET BLOCK #5



	-- Decompilation error in this vicinity:
	--- BLOCK #5 76-77, warpins: 2 ---
	return true
	--- END OF BLOCK #5 ---



end

SocialService.can_invite_to_party = function (self, player_info)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-7, warpins: 1 ---
	local player_online_status = player_info:online_status()

	if player_online_status ~= OnlineStatus.online and player_online_status ~= OnlineStatus.platform_online then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 12-14, warpins: 1 ---
		return false, nil
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 15-21, warpins: 3 ---
	local player_party_status = player_info:party_status()

	if player_party_status == PartyStatus.mine then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 22-26, warpins: 1 ---
		local reason = "loc_social_party_join_rejection_reason_same_party"

		return false, reason
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 27-30, warpins: 1 ---
		if player_party_status == PartyStatus.invite_pending then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 31-34, warpins: 1 ---
			local reason = "loc_social_party_join_rejection_reason_invite_pending"

			return false, reason
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 35-39, warpins: 3 ---
	local player_num_party_members = self._num_party_members

	if player_num_party_members == SocialConstants.max_num_party_members then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 40-43, warpins: 1 ---
		local reason = "loc_social_party_join_rejection_reason_party_full"

		return false, reason
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 44-48, warpins: 2 ---
	if player_info:player_activity_id() == "mission" then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 49-52, warpins: 1 ---
		local reason = "loc_social_party_join_rejection_reason_player_in_mission"

		return false, reason
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #3 ---

	FLOW; TARGET BLOCK #4



	-- Decompilation error in this vicinity:
	--- BLOCK #4 53-57, warpins: 2 ---
	if self:is_in_matchmaking() then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 58-61, warpins: 1 ---
		local reason = "loc_social_party_join_rejection_reason_you_are_in_matchmaking"

		return false, reason
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #4 ---

	FLOW; TARGET BLOCK #5



	-- Decompilation error in this vicinity:
	--- BLOCK #5 62-63, warpins: 2 ---
	return true
	--- END OF BLOCK #5 ---



end

SocialService.send_party_invite = function (self, invitee_player_info)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-7, warpins: 1 ---
	local player_online_status = invitee_player_info:online_status()

	if player_online_status == OnlineStatus.online then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 8-20, warpins: 1 ---
		Managers.party_immaterium:invite_to_party(invitee_player_info:account_id()):catch(function (error)

			-- Decompilation error in this vicinity:
			--- BLOCK #0 1-10, warpins: 1 ---
			_warning("invite_to_party failed with " .. table.tostring(error, 3))

			return
			--- END OF BLOCK #0 ---



		end)
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 21-24, warpins: 1 ---
		if player_online_status == OnlineStatus.platform_online then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 25-34, warpins: 1 ---
			local party_id = Managers.party_immaterium:party_id()
			local platform_user_id = invitee_player_info:platform_user_id()

			if party_id and platform_user_id then

				-- Decompilation error in this vicinity:
				--- BLOCK #0 37-42, warpins: 1 ---
				self._invites:send_invite(platform_user_id, party_id)
				--- END OF BLOCK #0 ---



			end
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 43-43, warpins: 5 ---
	return
	--- END OF BLOCK #1 ---



end

SocialService.cancel_party_invite = function (self, invitee_player_info)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-9, warpins: 1 ---
	Managers.party_immaterium:cancel_party_invite(invitee_player_info:account_id())

	return
	--- END OF BLOCK #0 ---



end

SocialService.join_party = function (self, party_id)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-6, warpins: 1 ---
	return Managers.party_immaterium:join_party(party_id)
	--- END OF BLOCK #0 ---



end

SocialService.leave_party = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-6, warpins: 1 ---
	Managers.party_immaterium:leave_party()

	return
	--- END OF BLOCK #0 ---



end

SocialService.can_kick_from_party = function (self, player_info)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-7, warpins: 1 ---
	local party_status = player_info:party_status()

	if party_status ~= PartyStatus.same_mission and party_status ~= PartyStatus.mine then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 12-13, warpins: 1 ---
		return false
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 14-18, warpins: 3 ---
	if self._num_party_members < SocialConstants.min_num_party_members_to_vote then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 19-21, warpins: 1 ---
		return false, "loc_social_fail_too_few_to_kick_vote"
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 22-23, warpins: 2 ---
	return true
	--- END OF BLOCK #2 ---



end

SocialService.initiate_kick_vote = function (self, player_info)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-6, warpins: 1 ---
	local peer_id = player_info:peer_id()

	if self._voting_id or not peer_id then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 9-9, warpins: 2 ---
		return
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 10-18, warpins: 1 ---
	local party_status = player_info:party_status()
	local is_in_mission = self:is_in_mission()
	local voting_template = nil

	if is_in_mission and (party_status == PartyStatus.same_mission or party_status == PartyStatus.mine) then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 27-27, warpins: 2 ---
		voting_template = "kick_from_mission"
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 28-29, warpins: 3 ---
	if voting_template then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 30-45, warpins: 1 ---
		Managers.voting:start_voting(voting_template, {
			kick_peer_id = peer_id
		}):next(function (data)

			-- Decompilation error in this vicinity:
			--- BLOCK #0 1-3, warpins: 1 ---
			self._voting_id = data

			return
			--- END OF BLOCK #0 ---



		end):catch(function (fail_reason)

			-- Decompilation error in this vicinity:
			--- BLOCK #0 1-9, warpins: 1 ---
			Log.info("SocialService", fail_reason)

			self._voting_id = nil

			return
			--- END OF BLOCK #0 ---



		end)
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 46-47, warpins: 2 ---
	return
	--- END OF BLOCK #3 ---

	FLOW; TARGET BLOCK #4



	-- Decompilation error in this vicinity:
	--- BLOCK #4 48-48, warpins: 2 ---
	--- END OF BLOCK #4 ---



end

SocialService.can_befriend = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	if self._max_fatshark_friends <= self._num_fatshark_friends then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 5-8, warpins: 1 ---
		local reason = "loc_social_cannot_befriend_reason_max_num_friends"

		return false, reason
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 9-10, warpins: 2 ---
	return true
	--- END OF BLOCK #1 ---



end

SocialService.send_friend_request = function (self, account_id)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-5, warpins: 1 ---
	local player_info = self._players_by_account_id[account_id]
	local friend_status = nil

	if player_info then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 6-14, warpins: 1 ---
		friend_status = player_info:friend_status()

		player_info:set_friend_status(FriendStatus.invited)
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 15-29, warpins: 2 ---
	return self._backend_interfaces:send_friend_request(account_id, "POST"):next(function (data)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-4, warpins: 1 ---
		self._friends_list_has_changed = true

		return
		--- END OF BLOCK #0 ---



	end):catch(function (error)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-11, warpins: 1 ---
		_warning(string.format("Failed sending friend request to %s: %s", account_id, error))

		if player_info and friend_status then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 15-19, warpins: 1 ---
			player_info:set_friend_status(friend_status)
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 20-20, warpins: 3 ---
		return
		--- END OF BLOCK #1 ---



	end)
	--- END OF BLOCK #1 ---



end

SocialService.accept_friend_request = function (self, account_id)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-5, warpins: 1 ---
	local player_info = self._players_by_account_id[account_id]
	local friend_status = nil

	if player_info then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 6-14, warpins: 1 ---
		friend_status = player_info:friend_status()

		player_info:set_friend_status(FriendStatus.friend)
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 15-29, warpins: 2 ---
	return self._backend_interfaces:send_friend_request(account_id, "PUT"):next(function (data)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-4, warpins: 1 ---
		self._friends_list_has_changed = true

		return
		--- END OF BLOCK #0 ---



	end):catch(function (error)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-11, warpins: 1 ---
		_warning(string.format("Failed sending friend request to %s: %s", account_id, error))

		if player_info and friend_status then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 15-19, warpins: 1 ---
			player_info:set_friend_status(friend_status)
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 20-20, warpins: 3 ---
		return
		--- END OF BLOCK #1 ---



	end)
	--- END OF BLOCK #1 ---



end

SocialService.reject_friend_request = function (self, account_id)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-5, warpins: 1 ---
	local player_info = self._players_by_account_id[account_id]
	local friend_status = nil

	if player_info then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 6-14, warpins: 1 ---
		friend_status = player_info:friend_status()

		player_info:set_friend_status(FriendStatus.none)
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 15-29, warpins: 2 ---
	return self._backend_interfaces:send_friend_request(account_id, "PATCH"):next(function (data)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-4, warpins: 1 ---
		self._friends_list_has_changed = true

		return
		--- END OF BLOCK #0 ---



	end):catch(function (error)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-9, warpins: 1 ---
		_warning(string.format("Failed sending friend request to %s: %s", account_id, error))

		return
		--- END OF BLOCK #0 ---



	end)
	--- END OF BLOCK #1 ---



end

SocialService.cancel_friend_request = function (self, account_id)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	local player_info = self._players_by_account_id[account_id]

	if player_info then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 5-9, warpins: 1 ---
		player_info:set_friend_status(FriendStatus.none)
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 10-24, warpins: 2 ---
	return self._backend_interfaces:send_friend_request(account_id, "DELETE"):next(function (data)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-10, warpins: 1 ---
		player_info:set_friend_status(FriendStatus.none)

		self._friends_list_has_changed = true

		return
		--- END OF BLOCK #0 ---



	end):catch(function (error)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-9, warpins: 1 ---
		_warning(string.format("Failed canceling friend request to %s: %s", account_id, error))

		return
		--- END OF BLOCK #0 ---



	end)
	--- END OF BLOCK #1 ---



end

SocialService.unfriend_player = function (self, account_id)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-5, warpins: 1 ---
	local player_info = self._players_by_account_id[account_id]
	local friend_status = nil

	if player_info then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 6-14, warpins: 1 ---
		friend_status = player_info:friend_status()

		player_info:set_friend_status(FriendStatus.none)
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 15-28, warpins: 2 ---
	return self._backend_interfaces:unfriend_player(account_id):next(function (data)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-10, warpins: 1 ---
		player_info:set_friend_status(FriendStatus.none)

		self._friends_list_has_changed = true

		return
		--- END OF BLOCK #0 ---



	end):catch(function (error)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-9, warpins: 1 ---
		_warning(string.format("Failed to un-friend %s: %s", account_id, error))

		return
		--- END OF BLOCK #0 ---



	end)
	--- END OF BLOCK #1 ---



end

SocialService.has_unread_notifications = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	return self._invites:has_invite()
	--- END OF BLOCK #0 ---



end

SocialService.can_mute_player_in_text_chat = function (self, account_id)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-2, warpins: 1 ---
	local player_info = account_id and self._players_by_account_id[account_id]

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 5-6, warpins: 2 ---
	if not player_info or player_info:online_status() ~= OnlineStatus.online then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 14-17, warpins: 2 ---
		local reason = "loc_social_fail_reason_user_not_online"

		return false, reason
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 18-20, warpins: 2 ---
	return false, "loc_social_fail_reason_not_implemented"
	--- END OF BLOCK #2 ---



end

SocialService.mute_player_in_text_chat = function (self, account_id, is_muted)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-9, warpins: 1 ---
	local player_info = self:_get_player_info_by_account_id(account_id)

	player_info:set_is_text_muted(is_muted)

	return
	--- END OF BLOCK #0 ---



end

SocialService.can_mute_player_in_voice_chat = function (self, account_id)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-2, warpins: 1 ---
	local player_info = account_id and self._players_by_account_id[account_id]

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 5-6, warpins: 2 ---
	if not player_info or player_info:online_status() ~= OnlineStatus.online then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 14-17, warpins: 2 ---
		local reason = "loc_social_fail_reason_user_not_online"

		return false, reason
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 18-20, warpins: 2 ---
	return false, "loc_social_fail_reason_not_implemented"
	--- END OF BLOCK #2 ---



end

SocialService.mute_player_in_voice_chat = function (self, account_id, is_muted)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-9, warpins: 1 ---
	local player_info = self:_get_player_info_by_account_id(account_id)

	player_info:set_is_voice_muted(is_muted)

	return
	--- END OF BLOCK #0 ---



end

SocialService.can_block = function (self, account_id)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-2, warpins: 1 ---
	local player_info = account_id and self._players_by_account_id[account_id]

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 5-6, warpins: 2 ---
	if not player_info or player_info:online_status() ~= OnlineStatus.online then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 14-18, warpins: 2 ---
		local reason = "loc_social_fail_reason_user_not_online"

		return false, reason
		--- END OF BLOCK #0 ---



	else

		-- Decompilation error in this vicinity:
		--- BLOCK #0 19-22, warpins: 1 ---
		if self._max_blocked_accounts <= self._num_blocked_accounts then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 23-26, warpins: 1 ---
			local reason = "loc_social_cannot_block_reason_max_num_reached"

			return false, reason
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 27-28, warpins: 3 ---
	return true
	--- END OF BLOCK #2 ---



end

SocialService.is_account_blocked = function (self, account_id)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-8, warpins: 1 ---
	return self:fetch_blocked_accounts():next(function (blocked_accounts)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-4, warpins: 1 ---
		return blocked_accounts[account_id] ~= nil
		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 8-8, warpins: 2 ---
		--- END OF BLOCK #1 ---



	end)
	--- END OF BLOCK #0 ---



end

SocialService.block_account = function (self, account_id)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	local player_info = self._players_by_account_id[account_id]

	if player_info then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 5-12, warpins: 1 ---
		player_info:set_is_blocked(true)

		self._friends_list_has_changed = true
		self._blocked_accounts_list_changed = true
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 13-22, warpins: 2 ---
	return self._backend_interfaces:add_blocked_account(account_id):catch(function (error)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-11, warpins: 1 ---
		_warning(string.format("Failed blocking account %s: %s", account_id, error))

		if player_info then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 12-22, warpins: 1 ---
			player_info:set_is_blocked(false)

			self._friends_list_has_changed = true
			self._blocked_accounts_list_changed = true
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 23-23, warpins: 2 ---
		return
		--- END OF BLOCK #1 ---



	end)
	--- END OF BLOCK #1 ---



end

SocialService.unblock_account = function (self, account_id)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	local player_info = self._players_by_account_id[account_id]

	if player_info then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 5-12, warpins: 1 ---
		player_info:set_is_blocked(false)

		self._friends_list_has_changed = true
		self._blocked_accounts_list_changed = true
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 13-22, warpins: 2 ---
	return self._backend_interfaces:remove_blocked_account(account_id):catch(function (error)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-9, warpins: 1 ---
		_warning(string.format("Failed unblocking account %s: %s", account_id, error))

		return
		--- END OF BLOCK #0 ---



	end)
	--- END OF BLOCK #1 ---



end

SocialService._fetch_platform_friends = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-13, warpins: 1 ---
	local platform_friends_manager = self._platform_social

	return platform_friends_manager:fetch_friends_list():next(function (platform_friends_data)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-5, warpins: 1 ---
		local friends = {}

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 6-13, warpins: 0 ---
		for i = 1, #platform_friends_data, 1 do

			-- Decompilation error in this vicinity:
			--- BLOCK #0 6-13, warpins: 2 ---
			local friend = platform_friends_data[i]
			local player_info = self:_get_player_info_by_platform_friend(friend)
			friends[i] = player_info
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #1 ---

		FLOW; TARGET BLOCK #2



		-- Decompilation error in this vicinity:
		--- BLOCK #2 14-14, warpins: 1 ---
		return friends
		--- END OF BLOCK #2 ---



	end):catch(function (error)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-10, warpins: 1 ---
		_warning(string.format("Failed fetching %s friends: %s", self._platform, error))

		return
		--- END OF BLOCK #0 ---



	end)
	--- END OF BLOCK #0 ---



end

SocialService.fetch_platform_block_list_ids_forced = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	local platform_friends_manager = self._platform_social

	return platform_friends_manager:fetch_blocked_list_ids_forced()
	--- END OF BLOCK #0 ---



end

SocialService._fetch_fatshark_friends = function (self)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-6, warpins: 1 ---
	local fatshark_friends_promise = self._fatshark_friends_promise

	if fatshark_friends_promise:is_pending() then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 7-7, warpins: 1 ---
		return fatshark_friends_promise
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 8-23, warpins: 1 ---
	fatshark_friends_promise = self._backend_interfaces:fetch_friends():next(function (fatshark_friends_data)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-9, warpins: 1 ---
		self._max_fatshark_friends = fatshark_friends_data.maxFriends
		local fatshark_friends = fatshark_friends_data.friends
		local friends = {}

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 10-29, warpins: 0 ---
		for i = 1, #fatshark_friends, 1 do

			-- Decompilation error in this vicinity:
			--- BLOCK #0 10-29, warpins: 2 ---
			local friend_data = fatshark_friends[i]
			local account_id = friend_data.accountId
			local account_name = friend_data.accountName
			local friend_status = friend_data.status
			local player_info = self:_get_player_info_by_account_id(account_id)

			player_info:set_account(account_id, account_name)
			player_info:set_friend_status(friend_status)

			friends[i] = player_info
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #1 ---

		FLOW; TARGET BLOCK #2



		-- Decompilation error in this vicinity:
		--- BLOCK #2 30-34, warpins: 1 ---
		if #friends ~= self._num_fatshark_friends then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 35-40, warpins: 1 ---
			self._num_fatshark_friends = #friends
			self._friends_list_has_changed = true
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #2 ---

		FLOW; TARGET BLOCK #3



		-- Decompilation error in this vicinity:
		--- BLOCK #3 41-41, warpins: 2 ---
		return friends
		--- END OF BLOCK #3 ---



	end):catch(function (error)

		-- Decompilation error in this vicinity:
		--- BLOCK #0 1-8, warpins: 1 ---
		_warning(string.format("Failed fetching fatshark friends: %s", error))

		return
		--- END OF BLOCK #0 ---



	end)
	self._fatshark_friends_promise = fatshark_friends_promise

	return fatshark_friends_promise
	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 24-24, warpins: 2 ---
	--- END OF BLOCK #2 ---



end

SocialService._update_blocked_players = function (self, blocked_accounts)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-12, warpins: 1 ---
	local blocked_players_list = self._blocked_players_list

	table.clear_array(blocked_players_list, #blocked_players_list)

	local previous_blocked_players = self._blocked_accounts_list
	local players_by_account_id = self._players_by_account_id

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 13-33, warpins: 0 ---
	for account_id, account_info in pairs(blocked_accounts) do

		-- Decompilation error in this vicinity:
		--- BLOCK #0 13-31, warpins: 1 ---
		local account_name = account_info.accountName
		previous_blocked_players[account_id] = nil
		local player_info = self:_get_player_info_by_account_id(account_id)

		player_info:set_account(account_id, account_name)
		player_info:set_is_blocked(true)

		blocked_players_list[#blocked_players_list + 1] = player_info
		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 32-33, warpins: 2 ---
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 34-37, warpins: 1 ---
	--- END OF BLOCK #2 ---

	FLOW; TARGET BLOCK #3



	-- Decompilation error in this vicinity:
	--- BLOCK #3 38-46, warpins: 0 ---
	for account_id in pairs(previous_blocked_players) do

		-- Decompilation error in this vicinity:
		--- BLOCK #0 38-40, warpins: 1 ---
		local player_info = players_by_account_id[account_id]

		if player_info then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 41-44, warpins: 1 ---
			player_info:set_is_blocked(false)
			--- END OF BLOCK #0 ---



		end
		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 45-46, warpins: 3 ---
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #3 ---

	FLOW; TARGET BLOCK #4



	-- Decompilation error in this vicinity:
	--- BLOCK #4 47-50, warpins: 1 ---
	self._blocked_accounts_list = blocked_accounts
	self._num_blocked_accounts = #blocked_players_list

	return
	--- END OF BLOCK #4 ---



end

SocialService._get_player_info_for_player = function (self, player)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-8, warpins: 1 ---
	local account_id = player:account_id()
	local player_info = self:_get_player_info_by_account_id(account_id)

	return player_info
	--- END OF BLOCK #0 ---



end

SocialService._get_player_info_by_platform_friend = function (self, friend)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-7, warpins: 1 ---
	local players_by_platform_user_id = self._players_by_platform_user_id
	local platform_user_id = friend:id()
	local player_info = players_by_platform_user_id[platform_user_id]

	if not player_info then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 8-14, warpins: 1 ---
		player_info = PlayerInfo:new(self._cb_presence_account_id_change)
		players_by_platform_user_id[platform_user_id] = player_info
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 15-19, warpins: 2 ---
	player_info:set_platform_social(friend)

	return player_info
	--- END OF BLOCK #1 ---



end

SocialService._get_player_info_by_account_id = function (self, account_id)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-4, warpins: 1 ---
	local players_by_account_id = self._players_by_account_id
	local player_info = players_by_account_id[account_id]

	if not player_info then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 5-15, warpins: 1 ---
		player_info = PlayerInfo:new(self._cb_presence_account_id_change)

		player_info:set_account(account_id)

		players_by_account_id[account_id] = player_info
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 16-16, warpins: 2 ---
	return player_info
	--- END OF BLOCK #1 ---



end

SocialService.cb_presence_account_id_change = function (self, updated_player_info)

	-- Decompilation error in this vicinity:
	--- BLOCK #0 1-7, warpins: 1 ---
	local account_id = updated_player_info:account_id()
	local player_info = self._players_by_account_id[account_id]

	if not player_info then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 8-10, warpins: 1 ---
		self._players_by_account_id[account_id] = updated_player_info
		player_info = updated_player_info
		--- END OF BLOCK #0 ---



	end

	--- END OF BLOCK #0 ---

	FLOW; TARGET BLOCK #1



	-- Decompilation error in this vicinity:
	--- BLOCK #1 11-15, warpins: 2 ---
	local platform_social = updated_player_info:platform_social()

	if platform_social then

		-- Decompilation error in this vicinity:
		--- BLOCK #0 16-20, warpins: 1 ---
		if platform_social ~= player_info:platform_social() then

			-- Decompilation error in this vicinity:
			--- BLOCK #0 21-24, warpins: 1 ---
			player_info:set_platform_social(platform_social)
			--- END OF BLOCK #0 ---



		end

		--- END OF BLOCK #0 ---

		FLOW; TARGET BLOCK #1



		-- Decompilation error in this vicinity:
		--- BLOCK #1 25-26, warpins: 2 ---
		self._players_by_platform_user_id[account_id] = player_info
		--- END OF BLOCK #1 ---



	end

	--- END OF BLOCK #1 ---

	FLOW; TARGET BLOCK #2



	-- Decompilation error in this vicinity:
	--- BLOCK #2 27-29, warpins: 2 ---
	self._friends_list_has_changed = true

	return
	--- END OF BLOCK #2 ---



end

return SocialService
